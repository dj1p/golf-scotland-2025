<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scotland Golf 2025</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .header h1 {
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 24px;
        }
        
        .header p {
            color: #718096;
            font-size: 14px;
        }
        
        .lang-toggle {
            position: fixed;
            top: 10px;
            right: 10px;
            background: white;
            padding: 8px 15px;
            border-radius: 10px;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            font-size: 14px;
        }
        
        .version-badge {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            color: #718096;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .nav-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .nav-card {
            background: white;
            border-radius: 15px;
            padding: 20px 15px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .nav-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }
        
        .nav-card h3 {
            color: #2d3748;
            margin: 10px 0 5px;
            font-size: 16px;
        }
        
        .nav-card p {
            color: #718096;
            font-size: 12px;
        }
        
        .icon {
            font-size: 40px;
            line-height: 1.2;
            margin-bottom: 10px;
        }
        
        .content {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: none;
            max-width: 100%;
            overflow-x: auto;
        }
        
        .content.active {
            display: block;
        }
        
        .back-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 15px;
            font-size: 14px;
        }
        
        .back-btn:hover {
            background: #5a67d8;
        }
        
        button {
            background: #48bb78;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        
        button:hover {
            background: #38a169;
        }

        .collapsible {
            background: #667eea;
            color: white;
            cursor: pointer;
            padding: 12px 15px;
            width: 100%;
            border: none;
            text-align: left;
            outline: none;
            font-size: 15px;
            border-radius: 8px;
            margin-top: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .collapsible:hover {
            background: #5a67d8;
        }

        .collapsible:after {
            content: '\002B';
            color: white;
            font-weight: bold;
            float: right;
            margin-left: 5px;
        }

        .collapsible.active:after {
            content: "\2212";
        }

        .collapsible-content {
            padding: 0 18px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.2s ease-out;
            background-color: #f7fafc;
            border-radius: 0 0 8px 8px;
            margin-bottom: 10px;
        }

        .collapsible-content.show {
            max-height: 2000px;
            padding: 18px;
            transition: max-height 0.3s ease-in;
        }

        .admin-section {
            background: #fff5f5;
            border: 2px solid #fc8181;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }
        
        .admin-section h4 {
            color: #c53030;
            margin-bottom: 10px;
        }

        .handicap-edit-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        
        .handicap-edit-item {
            background: white;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        
        .handicap-edit-item label {
            display: block;
            font-size: 12px;
            margin-bottom: 5px;
            font-weight: bold;
            color: #2d3748;
        }
        
        .handicap-edit-item input {
            width: 100%;
            padding: 8px;
            border: 1px solid #cbd5e0;
            border-radius: 5px;
            font-size: 14px;
        }

        .flight-time-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        
        .flight-time-item {
            background: white;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        /* Course Search Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 2000;
        }
        
        .modal-content {
            position: relative;
            margin: 50px auto;
            max-width: 800px;
            background: white;
            border-radius: 15px;
            padding: 20px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .search-input-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .search-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #38b2ac;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .search-btn {
            background: #38b2ac;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        
        .search-btn:hover {
            background: #319795;
        }
        
        .search-btn:disabled {
            background: #a0aec0;
            cursor: not-allowed;
        }
        
        .course-result-item {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .course-result-item:hover {
            border-color: #38b2ac;
            box-shadow: 0 4px 15px rgba(56, 178, 172, 0.2);
        }
        
        .course-result-item.selected {
            border-color: #38b2ac;
            background: #f0fdfa;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #38b2ac;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        select, input[type="text"], input[type="number"], input[type="time"], input[type="password"] {
            padding: 8px;
            border: 1px solid #cbd5e0;
            border-radius: 5px;
            font-size: 14px;
            width: 100%;
            margin: 5px 0;
        }

        .table-wrapper {
            overflow-x: auto;
            margin: 15px 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        th {
            background: #f7fafc;
            font-weight: bold;
            color: #2d3748;
        }

        tr:nth-child(even) {
            background: #f8f9fa;
        }

        .score-input {
            width: 50px;
            padding: 5px;
            border: 1px solid #cbd5e0;
            border-radius: 3px;
            text-align: center;
        }

        .hole-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .team-card {
            background: #f0f8ff;
            border-left: 4px solid #4299e1;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        
        @media (max-width: 768px) {
            .nav-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .search-input-container {
                flex-direction: column;
            }

            .handicap-edit-grid {
                grid-template-columns: 1fr;
            }

            .flight-time-grid {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 20px;
            }

            .nav-card h3 {
                font-size: 14px;
            }

            .nav-card p {
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <div class="lang-toggle" onclick="toggleLanguage()">
        <span id="langBtn">üá¨üáß EN</span>
    </div>

    <div class="version-badge">v8.0 - Fixed</div>

    <div class="container">
        <div class="header">
            <h1 id="appTitle">Scotland Golf 2025</h1>
            <p id="appSubtitle">√Örlig golftur til Skottland</p>
        </div>
        
        <div id="homeView" class="view">
            <div class="nav-grid">
                <div class="nav-card" onclick="showView('schedule')">
                    <div class="icon">üìÖ</div>
                    <h3 id="scheduleTitle">Timeplan</h3>
                    <p id="scheduleDesc">Se runder</p>
                </div>
                
                <div class="nav-card" onclick="showView('scorecard')">
                    <div class="icon">‚õ≥</div>
                    <h3 id="scorecardTitle">Registrer</h3>
                    <p id="scorecardDesc">Legg inn score</p>
                </div>
                
                <div class="nav-card" onclick="showView('leaderboard')">
                    <div class="icon">üèÜ</div>
                    <h3 id="leaderboardTitle">Resultater</h3>
                    <p id="leaderboardDesc">Live stilling</p>
                </div>
                
                <div class="nav-card" onclick="showView('courses')">
                    <div class="icon">üåç</div>
                    <h3 id="coursesTitle">Baner</h3>
                    <p id="coursesDesc">Scorekort</p>
                </div>
                
                <div class="nav-card" onclick="showView('players')">
                    <div class="icon">üë•</div>
                    <h3 id="playersTitle">Spillere</h3>
                    <p id="playersDesc">Handicap</p>
                </div>
                
                <div class="nav-card" onclick="showView('yearlyResults')">
                    <div class="icon">üìä</div>
                    <h3 id="yearlyTitle">√Örsresultater</h3>
                    <p id="yearlyDesc">Alle √•r</p>
                </div>
                
                <div class="nav-card" onclick="showView('history')">
                    <div class="icon">üìö</div>
                    <h3 id="historyTitle">Historie</h3>
                    <p id="historyDesc">Spillte baner</p>
                </div>
                
                <div class="nav-card" onclick="showView('whisky')">
                    <div class="icon">ü•É</div>
                    <h3 id="whiskyTitle">Whisky</h3>
                    <p id="whiskyDesc">Samlingen</p>
                </div>
                
                <div class="nav-card" onclick="showView('admin')">
                    <div class="icon">üîß</div>
                    <h3 id="adminTitle">Admin</h3>
                    <p id="adminDesc">Administrer</p>
                </div>
            </div>
        </div>
        
        <div id="scheduleView" class="content">
            <button class="back-btn" onclick="showView('home')">‚Üê Tilbake</button>
            <h2>Turneringsplan</h2>
            <div id="scheduleContent"></div>
        </div>
        
        <div id="scorecardView" class="content">
            <button class="back-btn" onclick="showView('home')">‚Üê Tilbake</button>
            <h2>Registrer Score</h2>
            <div id="scorecardContent"></div>
        </div>
        
        <div id="leaderboardView" class="content">
            <button class="back-btn" onclick="showView('home')">‚Üê Tilbake</button>
            <h2>Resultatliste</h2>
            <div id="leaderboardContent"></div>
        </div>
        
        <div id="coursesView" class="content">
            <button class="back-btn" onclick="showView('home')">‚Üê Tilbake</button>
            <h2>Scorekort per Bane</h2>
            <div id="coursesContent"></div>
        </div>
        
        <div id="playersView" class="content">
            <button class="back-btn" onclick="showView('home')">‚Üê Tilbake</button>
            <h2>Spillere</h2>
            <div id="playersContent"></div>
        </div>
        
        <div id="yearlyResultsView" class="content">
            <button class="back-btn" onclick="showView('home')">‚Üê Tilbake</button>
            <h2>√Örsresultater</h2>
            <div id="yearlyResultsContent"></div>
        </div>
        
        <div id="historyView" class="content">
            <button class="back-btn" onclick="showView('home')">‚Üê Tilbake</button>
            <h2>Spillte Baner Gjennom √Örene</h2>
            <div id="historyContent"></div>
        </div>
        
        <div id="whiskyView" class="content">
            <button class="back-btn" onclick="showView('home')">‚Üê Tilbake</button>
            <h2>Whisky Samlingen</h2>
            <div id="whiskyContent"></div>
        </div>
        
        <div id="adminView" class="content">
            <button class="back-btn" onclick="showView('home')">‚Üê Tilbake</button>
            <h2>Administrator</h2>
            <div id="adminContent"></div>
        </div>

        <!-- Course Search Modal -->
        <div id="courseSearchModal" class="modal">
            <div class="modal-content">
                <h3>S√∏k Golf Baner</h3>
                <div class="search-input-container">
                    <input type="text" id="searchQuery" class="search-input" placeholder="S√∏k etter bane eller klubb (f.eks. St Andrews, Carnoustie)" onkeypress="if(event.key==='Enter') performCourseSearch()">
                    <button id="searchBtn" class="search-btn" onclick="performCourseSearch()">S√∏k</button>
                </div>
                <div id="searchResults"></div>
                <div id="selectedCourseDetails"></div>
                <button onclick="hideCourseSearch()" style="background: #718096; margin-top: 20px;">Lukk</button>
            </div>
        </div>
    </div>

<script>
// Global variables
var currentYear = 2025;
var language = 'no';
var isAdmin = false;
var useSlope = true;
var scrambleFormula = 'standard';

// Golf Course API Configuration  
var API_KEY = 'BOJ4YISLOCFRSQSTZPSGZUP4DU';
var API_BASE_URL = 'https://api.golfcourseapi.com';

// Data structures
var players = [
    { id: 1, name: 'Klaus', handicap: 18.1 },
    { id: 2, name: 'Ruben', handicap: 11 },
    { id: 3, name: 'Sigbj√∏rn', handicap: 20.2 },
    { id: 4, name: 'Bj√∏rn', handicap: 23.8 },
    { id: 5, name: 'Truls', handicap: 36 },
    { id: 6, name: 'Tor Espen', handicap: 27 },
    { id: 7, name: 'Dag', handicap: 19.4 },
    { id: 8, name: 'Roar', handicap: 25.9 }
];

var schedule = [
    { 
        id: 1, 
        date: 'Fredag 29. aug', 
        time: 'Morgen', 
        course: 'Cullen Links', 
        courseId: null,
        teeData: null,
        type: 'Scramble',
        longestDrive: [5, 15],
        closestToPin: [2, 13],
        teams: [['Klaus', 'Ruben'], ['Sigbj√∏rn', 'Bj√∏rn'], ['Truls', 'Tor Espen'], ['Dag', 'Roar']]
    },
    { 
        id: 2, 
        date: 'Fredag 29. aug', 
        time: 'Ettermiddag', 
        course: 'Cullen Links', 
        courseId: null,
        teeData: null,
        type: 'Individuell',
        longestDrive: [5, 15],
        closestToPin: [2, 13],
        flights: [
            { time: '14:00', players: ['Klaus', 'Ruben', 'Roar', 'Sigbj√∏rn'] },
            { time: '14:10', players: ['Dag', 'Tor Espen', 'Truls', 'Bj√∏rn'] }
        ]
    },
    { 
        id: 3, 
        date: 'L√∏rdag 30. aug', 
        time: 'Morgen', 
        course: 'Spey Bay', 
        courseId: null,
        teeData: null,
        type: 'Individuell',
        longestDrive: [5, 16],
        closestToPin: [4, 15],
        flights: [
            { time: '09:00', players: ['Klaus', 'Tor Espen', 'Sigbj√∏rn', 'Bj√∏rn'] },
            { time: '09:10', players: ['Dag', 'Ruben', 'Truls', 'Roar'] }
        ]
    },
    { 
        id: 4, 
        date: 'L√∏rdag 30. aug', 
        time: 'Ettermiddag', 
        course: 'Garmouth & Kingston', 
        courseId: null,
        teeData: null,
        type: 'Scramble',
        longestDrive: [8],
        closestToPin: [3],
        teams: [['Truls', 'Roar'], ['Klaus', 'Sigbj√∏rn'], ['Bj√∏rn', 'Dag'], ['Ruben', 'Tor Espen']]
    },
    { 
        id: 5, 
        date: 'S√∏ndag 31. aug', 
        time: 'Hele dagen', 
        course: 'Strathlene', 
        courseId: null,
        teeData: null,
        type: 'Individuell',
        longestDrive: [8],
        closestToPin: [7],
        flights: [
            { time: '09:30', players: ['Klaus', 'Dag', 'Roar', 'Truls'] },
            { time: '09:40', players: ['Ruben', 'Sigbj√∏rn', 'Tor Espen', 'Bj√∏rn'] }
        ]
    }
];

// Default course data from Excel
var courses = {
    'Cullen Links': { 
        slopeRating: 93, 
        par: 63,
        pars: [4,3,3,3,4,3,3,4,3,4,3,3,3,3,5,4,4,4],
        handicaps: [9,7,1,11,3,13,5,17,15,14,6,2,4,8,10,12,18,16]
    },
    'Spey Bay': { 
        slopeRating: 114, 
        par: 70,
        pars: [4,4,4,3,4,4,4,3,5,4,4,4,3,4,3,5,4,4],
        handicaps: [3,11,7,9,1,17,5,13,15,16,8,4,10,2,14,12,18,6]
    },
    'Strathlene': { 
        slopeRating: 114, 
        par: 70,
        pars: [4,4,4,3,4,4,3,4,4,4,4,4,3,5,4,4,4,3],
        handicaps: [12,16,7,5,9,10,18,3,1,14,8,2,17,11,4,15,6,13]
    },
    'Garmouth & Kingston': { 
        slopeRating: 114, 
        par: 67,
        pars: [4,4,4,3,4,4,4,4,3,4,4,4,3,4,3,4,4,3],
        handicaps: [7,8,1,9,10,5,14,3,12,6,15,17,18,11,13,2,4,16]
    }
};

var scores = {};
var scrambleScores = {};
var awards = {};
var flightTimes = {};
var whiskyCollection = [
    { id: 1, player: 'Klaus', primary: '', reserve: '' },
    { id: 2, player: 'Ruben', primary: '', reserve: '' },
    { id: 3, player: 'Sigbj√∏rn', primary: '', reserve: '' },
    { id: 4, player: 'Bj√∏rn', primary: '', reserve: '' },
    { id: 5, player: 'Truls', primary: '', reserve: '' },
    { id: 6, player: 'Tor Espen', primary: '', reserve: '' },
    { id: 7, player: 'Dag', primary: '', reserve: '' },
    { id: 8, player: 'Roar', primary: '', reserve: '' }
];

// Historical data
var playedCourses = [
    { name: 'Royal Dornoch', years: [2010, 2011, 2015, 2018] },
    { name: 'Carnoustie Championship Course', years: [2012, 2016, 2019] },
    { name: 'St Andrews Old Course', years: [2013, 2017, 2020] },
    { name: 'Turnberry Ailsa', years: [2014, 2021] },
    { name: 'Muirfield', years: [2015, 2022] },
    { name: 'Royal Troon', years: [2016, 2023] },
    { name: 'Prestwick Golf Club', years: [2017] },
    { name: 'North Berwick Golf Club', years: [2018] },
    { name: 'Machrihanish Golf Club', years: [2019] },
    { name: 'Kingsbarns Golf Links', years: [2020] },
    { name: 'Castle Stuart Golf Links', years: [2021] },
    { name: 'Trump International Golf Links', years: [2022] },
    { name: 'Cruden Bay Golf Club', years: [2023] },
    { name: 'Royal Aberdeen Golf Club', years: [2024] }
];

// Golf Course API search variables
var currentSearchResults = [];
var selectedCourseForRound = null;
var selectedTeeData = null;
var selectedCourseData = null;

// Core functionality functions
function showView(viewName) {
    document.querySelectorAll('.content').forEach(function(el) {
        el.classList.remove('active');
    });
    
    document.getElementById('homeView').style.display = viewName === 'home' ? 'block' : 'none';
    
    if (viewName !== 'home') {
        document.getElementById(viewName + 'View').classList.add('active');
        
        // Load specific view content
        if (viewName === 'admin') loadAdmin();
        if (viewName === 'schedule') loadSchedule();
        if (viewName === 'courses') loadCourses();
        if (viewName === 'players') loadPlayers();
        if (viewName === 'leaderboard') loadLeaderboard();
        if (viewName === 'history') loadHistory();
        if (viewName === 'whisky') loadWhisky();
        if (viewName === 'yearlyResults') loadYearlyResults();
        if (viewName === 'scorecard') loadScorecard();
    }
}

function toggleLanguage() {
    language = language === 'no' ? 'en' : 'no';
    document.getElementById('langBtn').textContent = language === 'no' ? 'üá¨üáß EN' : 'üá≥üá¥ NO';
    
    // Update text elements based on language
    updateLanguageText();
}

function updateLanguageText() {
    var texts = {
        no: {
            appTitle: 'Scotland Golf 2025',
            appSubtitle: '√Örlig golftur til Skottland',
            scheduleTitle: 'Timeplan', scheduleDesc: 'Se runder',
            scorecardTitle: 'Registrer', scorecardDesc: 'Legg inn score',
            leaderboardTitle: 'Resultater', leaderboardDesc: 'Live stilling',
            coursesTitle: 'Baner', coursesDesc: 'Scorekort',
            playersTitle: 'Spillere', playersDesc: 'Handicap',
            yearlyTitle: '√Örsresultater', yearlyDesc: 'Alle √•r',
            historyTitle: 'Historie', historyDesc: 'Spillte baner',
            whiskyTitle: 'Whisky', whiskyDesc: 'Samlingen',
            adminTitle: 'Admin', adminDesc: 'Administrer'
        },
        en: {
            appTitle: 'Scotland Golf 2025',
            appSubtitle: 'Annual golf trip to Scotland',
            scheduleTitle: 'Schedule', scheduleDesc: 'View rounds',
            scorecardTitle: 'Score Entry', scorecardDesc: 'Enter scores',
            leaderboardTitle: 'Results', leaderboardDesc: 'Live standings',
            coursesTitle: 'Courses', coursesDesc: 'Scorecards',
            playersTitle: 'Players', playersDesc: 'Handicaps',
            yearlyTitle: 'Yearly Results', yearlyDesc: 'All years',
            historyTitle: 'History', historyDesc: 'Played courses',
            whiskyTitle: 'Whisky', whiskyDesc: 'Collection',
            adminTitle: 'Admin', adminDesc: 'Manage'
        }
    };
    
    var currentTexts = texts[language];
    Object.keys(currentTexts).forEach(function(key) {
        var element = document.getElementById(key);
        if (element) {
            element.textContent = currentTexts[key];
        }
    });
}

function toggleSection(element) {
    element.classList.toggle("active");
    var content = element.nextElementSibling;
    content.classList.toggle("show");
}

// Admin functions
function loadAdmin() {
    var html = '';
    
    if (!isAdmin) {
        html = '<div class="admin-section">';
        html += '<h3>Admin P√•logging</h3>';
        html += '<p>Passord:</p>';
        html += '<input type="password" id="adminPassword" placeholder="Skriv inn passord">';
        html += '<button onclick="loginAdmin()" style="margin-top: 10px;">Logg inn</button>';
        html += '</div>';
    } else {
        html = '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">';
        html += '<h3>Admin Panel</h3>';
        html += '<button onclick="logoutAdmin()" style="background: #e53e3e;">Logg ut</button>';
        html += '</div>';
        
        // Handicap calculation method toggle
        html += '<button class="collapsible" onclick="toggleSection(this)">‚öôÔ∏è Handicap Beregningsmetode</button>';
        html += '<div class="collapsible-content">';
        html += '<div style="background: #e6f4ff; padding: 15px; border-radius: 10px;">';
        html += '<h4>Handicap Beregning</h4>';
        html += '<div style="margin: 15px 0;">';
        html += '<label style="display: block; margin-bottom: 10px;">';
        html += '<input type="radio" name="handicapMethod" value="slope" ' + (useSlope ? 'checked' : '') + ' onchange="toggleHandicapMethod(true)">';
        html += ' <strong>Slope-basert</strong> - Bruker slope rating for √• beregne banehandicap';
        html += '</label>';
        html += '<label style="display: block;">';
        html += '<input type="radio" name="handicapMethod" value="individual" ' + (!useSlope ? 'checked' : '') + ' onchange="toggleHandicapMethod(false)">';
        html += ' <strong>Individuell</strong> - Bruker spillerens handicap direkte';
        html += '</label>';
        html += '</div>';
        html += '<div style="margin-top: 15px;">';
        html += '<h5>Scramble Formel:</h5>';
        html += '<select onchange="changeScrambleFormula(this.value)">';
        html += '<option value="standard"' + (scrambleFormula === 'standard' ? ' selected' : '') + '>Standard (35% lav + 15% h√∏y)</option>';
        html += '<option value="usga"' + (scrambleFormula === 'usga' ? ' selected' : '') + '>USGA (50% lav + 10% h√∏y)</option>';
        html += '<option value="custom"' + (scrambleFormula === 'custom' ? ' selected' : '') + '>Tilpasset (70% lav + 30% h√∏y)</option>';
        html += '</select>';
        html += '</div>';
        html += '<p style="color: #718096; font-size: 12px; margin-top: 10px;">Aktuell metode: ' + (useSlope ? 'Slope-basert' : 'Individuell') + '</p>';
        html += '</div>';
        html += '</div>';
        
        // Course management
        html += '<button class="collapsible" onclick="toggleSection(this)">üåç Bane Administrasjon</button>';
        html += '<div class="collapsible-content">';
        html += '<div style="background: #f0fdf4; padding: 15px; border-radius: 10px;">';
        html += '<h4>Administrer Baner for Turneringen</h4>';
        
        schedule.forEach(function(round, index) {
            html += '<div style="background: white; padding: 15px; margin: 10px 0; border-radius: 8px; border: 1px solid #e2e8f0;">';
            html += '<h5>Runde ' + (index + 1) + ': ' + round.date + ' - ' + round.time + ' (' + round.type + ')</h5>';
            html += '<p><strong>Valgt bane:</strong> ' + (round.course || 'Ingen bane valgt') + '</p>';
            if (round.courseId) {
                html += '<p style="color: #4299e1; font-size: 12px;">API ID: ' + round.courseId + '</p>';
            }
            html += '<div style="margin-top: 10px;">';
            html += '<button onclick="showCourseSearch(' + round.id + ')" style="background: #38b2ac;">Velg/Endre Bane</button>';
            html += '<button onclick="updateRound(' + round.id + ')" style="background: #4299e1; margin-left: 10px;">Oppdater Runde</button>';
            html += '</div>';
            html += '</div>';
        });
        
        html += '<div style="margin-top: 20px;">';
        html += '<button onclick="addNewRound()" style="background: #48bb78;">Legg til Ny Runde</button>';
        html += '</div>';
        html += '</div>';
        html += '</div>';
        // Schedule management
html += '<button class="collapsible" onclick="toggleSection(this)">üìÖ Turneringsplan</button>';
html += '<div class="collapsible-content">';
html += '<div style="background: #f0f8ff; padding: 15px; border-radius: 10px;">';
html += '<h4>Rediger Datoer og Tider</h4>';

schedule.forEach(function(round, index) {
    html += '<div style="background: white; padding: 15px; margin: 10px 0; border-radius: 8px; border: 1px solid #e2e8f0;">';
    html += '<h5>Runde ' + (index + 1) + ': ' + round.type + '</h5>';
    
    // Date editing
    html += '<div style="margin: 10px 0;">';
    html += '<label for="date_' + round.id + '">Dato:</label>';
    html += '<input type="text" id="date_' + round.id + '" value="' + round.date + '" placeholder="f.eks. Fredag 29. aug" onchange="updateRoundDate(' + round.id + ', this.value)">';
    html += '</div>';
    
    // Time editing
    html += '<div style="margin: 10px 0;">';
    html += '<label for="time_' + round.id + '">Tid:</label>';
    html += '<input type="text" id="time_' + round.id + '" value="' + round.time + '" placeholder="f.eks. Morgen, Ettermiddag" onchange="updateRoundTime(' + round.id + ', this.value)">';
    html += '</div>';
    
    // Course display
    html += '<div style="margin: 10px 0;">';
    html += '<label>Bane:</label>';
    html += '<span style="padding: 8px; background: #f7fafc; border-radius: 4px; display: inline-block;">' + (round.course || 'Ikke valgt') + '</span>';
    html += '</div>';
    
    // Tee time for the course (single time per round)
    html += '<div style="margin: 10px 0;">';
    html += '<label for="tee_time_' + round.id + '">Tee Time:</label>';
    html += '<input type="time" id="tee_time_' + round.id + '" value="' + (round.teeTime || '') + '" onchange="updateTeeTime(' + round.id + ', this.value)">';
    html += '</div>';
    
    // Show flight details for individual rounds
    if (round.type === 'Individuell' && round.flights) {
        html += '<div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px;">';
        html += '<h6>Flight Detaljer:</h6>';
        round.flights.forEach(function(flight, flightIndex) {
            html += '<div style="margin: 5px 0; font-size: 12px;">';
            html += '<strong>Flight ' + (flightIndex + 1) + ':</strong> ' + flight.players.join(', ');
            html += ' <em>(Tid: ' + (flight.time || 'Ikke satt') + ')</em>';
            html += '</div>';
        });
        html += '</div>';
    }
    
    // Show team details for scramble rounds
    if (round.type === 'Scramble' && round.teams) {
        html += '<div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px;">';
        html += '<h6>Lag:</h6>';
        round.teams.forEach(function(team, teamIndex) {
            html += '<div style="margin: 5px 0; font-size: 12px;">';
            html += '<strong>Lag ' + (teamIndex + 1) + ':</strong> ' + team.join(' & ');
            html += '</div>';
        });
        html += '</div>';
    }
    
    html += '</div>';
});

html += '<div style="margin-top: 15px; text-align: center;">';
html += '<button onclick="saveSchedule()" style="background: #48bb78; margin-right: 10px;">Lagre Endringer</button>';
html += '<button onclick="resetSchedule()" style="background: #e53e3e;">Tilbakestill</button>';
html += '</div>';

html += '</div>';
html += '</div>';
        
        // Handicap editing
        html += '<button class="collapsible" onclick="toggleSection(this)">‚úèÔ∏è Rediger Handicap</button>';
        html += '<div class="collapsible-content">';
        html += '<div class="handicap-edit-grid">';
        players.forEach(function(player) {
            html += '<div class="handicap-edit-item">';
            html += '<label for="handicap_' + player.id + '">' + player.name + '</label>';
            html += '<input type="number" id="handicap_' + player.id + '" value="' + player.handicap + '" step="0.1" min="0" max="54" onchange="updateHandicap(' + player.id + ', this.value)">';
            html += '</div>';
        });
        html += '</div>';
        html += '<button onclick="saveHandicaps()" style="margin-top: 15px;">Lagre Handicap</button>';
        html += '</div>';
        
        // Flight times
        html += '<button class="collapsible" onclick="toggleSection(this)">‚è∞ Flight Tider</button>';
        html += '<div class="collapsible-content">';
        html += '<div style="background: #fef5e7; padding: 15px; border-radius: 10px;">';
        html += '<h4>Sett Starttider</h4>';
        
        schedule.forEach(function(round) {
            if (round.type === 'Individuell' && round.flights) {
                html += '<h5>' + round.date + ' - ' + round.time + '</h5>';
                round.flights.forEach(function(flight, flightIndex) {
                    html += '<div class="flight-time-item">';
                    html += '<label>Flight ' + (flightIndex + 1) + ' (' + flight.players.join(', ') + ')</label>';
                    html += '<input type="time" id="flight_' + round.id + '_' + flightIndex + '" value="' + (flight.time || '') + '" onchange="updateFlightTime(' + round.id + ', ' + flightIndex + ', this.value)">';
                    html += '</div>';
                });
            }
        });
        
        html += '<button onclick="saveFlightTimes()" style="margin-top: 15px;">Lagre Tider</button>';
        html += '</div>';
        html += '</div>';
        
        // Competition holes
        html += '<button class="collapsible" onclick="toggleSection(this)">üéØ Konkurransehull</button>';
        html += '<div class="collapsible-content">';
        html += '<div style="background: #fff5f5; padding: 15px; border-radius: 10px;">';
        html += '<h4>Sett Longest Drive og Closest to Pin Hull</h4>';
        
        schedule.forEach(function(round) {
            html += '<div style="background: white; padding: 15px; margin: 10px 0; border-radius: 8px; border: 1px solid #e2e8f0;">';
            html += '<h5>' + round.date + ' - ' + round.time + '</h5>';
            html += '<div style="margin: 10px 0;">';
            html += '<label>Longest Drive Hull (kommaseparert):</label>';
            html += '<input type="text" id="longest_' + round.id + '" value="' + (round.longestDrive || []).join(',') + '" placeholder="f.eks. 5,15" onchange="updateCompetitionHoles(' + round.id + ', \'longest\', this.value)">';
            html += '</div>';
            html += '<div style="margin: 10px 0;">';
            html += '<label>Closest to Pin Hull (kommaseparert):</label>';
            html += '<input type="text" id="closest_' + round.id + '" value="' + (round.closestToPin || []).join(',') + '" placeholder="f.eks. 2,13" onchange="updateCompetitionHoles(' + round.id + ', \'closest\', this.value)">';
            html += '</div>';
            html += '</div>';
        });
        
        html += '<button onclick="saveCompetitionHoles()" style="margin-top: 15px;">Lagre Konkurransehull</button>';
        html += '</div>';
        html += '</div>';
        
        // Award winners
        html += '<button class="collapsible" onclick="toggleSection(this)">üèÜ Premieutdeling</button>';
        html += '<div class="collapsible-content">';
        html += '<div style="background: #f0fdf4; padding: 15px; border-radius: 10px;">';
        html += '<h4>Velg Vinnere</h4>';
        
        schedule.forEach(function(round) {
            html += '<div style="background: white; padding: 15px; margin: 10px 0; border-radius: 8px; border: 1px solid #e2e8f0;">';
            html += '<h5>' + round.date + ' - ' + round.time + '</h5>';
            
            // Longest drive winners
            if (round.longestDrive && round.longestDrive.length > 0) {
                round.longestDrive.forEach(function(hole) {
                    html += '<div style="margin: 10px 0;">';
                    html += '<label>Longest Drive Hull ' + hole + ':</label>';
                    html += '<select id="award_ld_' + round.id + '_' + hole + '" onchange="updateAward(' + round.id + ', \'longest\', ' + hole + ', this.value)">';
                    html += '<option value="">Velg vinner</option>';
                    players.forEach(function(player) {
                        var currentWinner = awards[round.id + '_longest_' + hole] || '';
                        html += '<option value="' + player.name + '"' + (currentWinner === player.name ? ' selected' : '') + '>' + player.name + '</option>';
                    });
                    html += '</select>';
                    html += '</div>';
                });
            }
            
            // Closest to pin winners
            if (round.closestToPin && round.closestToPin.length > 0) {
                round.closestToPin.forEach(function(hole) {
                    html += '<div style="margin: 10px 0;">';
                    html += '<label>Closest to Pin Hull ' + hole + ':</label>';
                    html += '<select id="award_ctp_' + round.id + '_' + hole + '" onchange="updateAward(' + round.id + ', \'closest\', ' + hole + ', this.value)">';
                    html += '<option value="">Velg vinner</option>';
                    players.forEach(function(player) {
                        var currentWinner = awards[round.id + '_closest_' + hole] || '';
                        html += '<option value="' + player.name + '"' + (currentWinner === player.name ? ' selected' : '') + '>' + player.name + '</option>';
                    });
                    html += '</select>';
                    html += '</div>';
                });
            }
            html += '</div>';
        });
        
        html += '<button onclick="saveAwards()" style="margin-top: 15px;">Lagre Vinnere</button>';
        html += '</div>';
        html += '</div>';
        
        // Whisky management
        html += '<button class="collapsible" onclick="toggleSection(this)">ü•É Whisky Administrasjon</button>';
        html += '<div class="collapsible-content">';
        html += '<div style="background: #fef5e7; padding: 15px; border-radius: 10px;">';
        html += '<h4>Administrer Whisky Samling</h4>';
        html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin: 15px 0;">';
        
        whiskyCollection.forEach(function(entry) {
            html += '<div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0;">';
            html += '<h5>' + entry.player + '</h5>';
            html += '<label>Prim√¶r whisky:</label>';
            html += '<input type="text" id="whisky_primary_' + entry.id + '" value="' + (entry.primary || '') + '" placeholder="Navn p√• whisky">';
            html += '<label style="margin-top: 10px;">Reserve whisky:</label>';
            html += '<input type="text" id="whisky_reserve_' + entry.id + '" value="' + (entry.reserve || '') + '" placeholder="Reserve whisky">';
            html += '</div>';
        });
        
        html += '</div>';
        html += '<button onclick="saveWhisky()" style="margin-top: 15px;">Lagre Whisky Data</button>';
        html += '</div>';
        html += '</div>';
    }
    
    document.getElementById('adminContent').innerHTML = html;
}

function loginAdmin() {
    var password = document.getElementById('adminPassword').value;
    if (password === 'golf') {
        isAdmin = true;
        loadAdmin();
        saveToServer();
    } else {
        alert('Feil passord!');
    }
}

function logoutAdmin() {
    isAdmin = false;
    loadAdmin();
    saveToServer();
}

// Handicap calculation functions
function toggleHandicapMethod(useSlope) {
    window.useSlope = useSlope;
    saveToServer();
    alert('Handicap beregningsmetode endret!');
}

function changeScrambleFormula(formula) {
    scrambleFormula = formula;
    saveToServer();
    alert('Scramble formel endret til: ' + formula);
}

function calculateCourseHandicap(playerHandicap, courseName) {
    var course = courses[courseName];
    if (!course || !useSlope) {
        return Math.round(playerHandicap);
    }
    return Math.round((playerHandicap * course.slopeRating) / 113);
}

function calculateScrambleHandicap(teamMembers, courseName) {
    var playerHandicaps = [];
    
    teamMembers.forEach(function(memberName) {
        var player = players.find(function(p) { return p.name === memberName; });
        if (player) {
            if (useSlope) {
                var courseHandicap = calculateCourseHandicap(player.handicap, courseName);
                playerHandicaps.push(courseHandicap);
            } else {
                playerHandicaps.push(player.handicap);
            }
        }
    });
    
    playerHandicaps.sort(function(a, b) { return a - b; });
    
    if (playerHandicaps.length >= 2) {
        var lowest = playerHandicaps[0];
        var highest = playerHandicaps[playerHandicaps.length - 1];
        
        var teamHandicap;
        if (scrambleFormula === 'standard') {
            teamHandicap = (lowest * 0.35) + (highest * 0.15);
        } else if (scrambleFormula === 'usga') {
            teamHandicap = (lowest * 0.5) + (highest * 0.1);
        } else { // custom
            teamHandicap = (lowest * 0.7) + (highest * 0.3);
        }
        
        return Math.round(teamHandicap * 10) / 10;
    }
    
    return playerHandicaps[0] || 0;
}

function getPlayerStrokes(courseHandicap, hole, course) {
    if (!course || !course.handicaps) return 0;
    
    var strokeIndex = course.handicaps[hole - 1];
    
    if (courseHandicap >= 36) {
        if (strokeIndex <= (courseHandicap - 36)) return 3;
        else if (strokeIndex <= (courseHandicap - 18)) return 2;
        else return 1;
    } else if (courseHandicap >= 18) {
        if (strokeIndex <= (courseHandicap - 18)) return 2;
        else return 1;
    } else {
        return strokeIndex <= courseHandicap ? 1 : 0;
    }
}

// Admin editing functions
function updateHandicap(playerId, newHandicap) {
    var player = players.find(function(p) { return p.id === playerId; });
    if (player) {
        player.handicap = parseFloat(newHandicap) || 0;
    }
}

function saveHandicaps() {
    players.forEach(function(player) {
        var input = document.getElementById('handicap_' + player.id);
        if (input) {
            player.handicap = parseFloat(input.value) || 0;
        }
    });
    saveToServer();
    alert('Handicap lagret!');
}

function updateFlightTime(roundId, flightIndex, time) {
    var round = schedule.find(function(r) { return r.id === roundId; });
    if (round && round.flights && round.flights[flightIndex]) {
        round.flights[flightIndex].time = time;
    }
}

function saveFlightTimes() {
    schedule.forEach(function(round) {
        if (round.flights) {
            round.flights.forEach(function(flight, index) {
                var timeInput = document.getElementById('flight_' + round.id + '_' + index);
                if (timeInput) {
                    flight.time = timeInput.value;
                }
            });
        }
    });
    saveToServer();
    alert('Flight tider lagret!');
}

function updateCompetitionHoles(roundId, type, value) {
    var round = schedule.find(function(r) { return r.id === roundId; });
    if (round) {
        var holes = value.split(',').map(function(h) { return parseInt(h.trim()); }).filter(function(h) { return !isNaN(h); });
        if (type === 'longest') {
            round.longestDrive = holes;
        } else if (type === 'closest') {
            round.closestToPin = holes;
        }
    }
}

function saveCompetitionHoles() {
    schedule.forEach(function(round) {
        var longestInput = document.getElementById('longest_' + round.id);
        var closestInput = document.getElementById('closest_' + round.id);
        
        if (longestInput) {
            updateCompetitionHoles(round.id, 'longest', longestInput.value);
        }
        if (closestInput) {
            updateCompetitionHoles(round.id, 'closest', closestInput.value);
        }
    });
    saveToServer();
    alert('Konkurransehull lagret!');
}

function updateAward(roundId, type, hole, winner) {
    var key = roundId + '_' + type + '_' + hole;
    awards[key] = winner;
}

function saveAwards() {
    saveToServer();
    alert('Vinnere lagret!');
}

function saveWhisky() {
    whiskyCollection.forEach(function(entry) {
        var primaryInput = document.getElementById('whisky_primary_' + entry.id);
        var reserveInput = document.getElementById('whisky_reserve_' + entry.id);
        
        if (primaryInput) entry.primary = primaryInput.value;
        if (reserveInput) entry.reserve = reserveInput.value;
    });
    saveToServer();
    alert('Whisky data lagret!');
}

// Course Search and API functions
function showCourseSearch(roundId) {
    selectedCourseForRound = roundId;
    document.getElementById('courseSearchModal').style.display = 'block';
    document.getElementById('searchQuery').value = '';
    document.getElementById('searchResults').innerHTML = '';
    document.getElementById('selectedCourseDetails').innerHTML = '';
}

function hideCourseSearch() {
    document.getElementById('courseSearchModal').style.display = 'none';
    selectedCourseForRound = null;
    selectedTeeData = null;
    selectedCourseData = null;
}

async function performCourseSearch() {
    var query = document.getElementById('searchQuery').value.trim();
    if (!query) return;
    
    var searchBtn = document.getElementById('searchBtn');
    var resultsDiv = document.getElementById('searchResults');
    
    searchBtn.disabled = true;
    searchBtn.innerHTML = '<span class="loading-spinner"></span> S√∏ker...';
    
    try {
        var response = await fetch(`${API_BASE_URL}/v1/search?search_query=${encodeURIComponent(query)}`, {
            headers: {
                'Authorization': 'Key ' + API_KEY
            }
        });
        
        if (!response.ok) {
            throw new Error(`API request failed: ${response.status}`);
        }
        
        var data = await response.json();
        var courses = data.courses || [];
        currentSearchResults = courses;
        
        if (courses.length === 0) {
            resultsDiv.innerHTML = '<p style="text-align: center; color: #718096;">Ingen baner funnet.</p>';
        } else {
            displaySearchResults(courses);
        }
    } catch (error) {
        resultsDiv.innerHTML = `<div style="color: red; padding: 15px;">Feil ved s√∏k: ${error.message}</div>`;
    } finally {
        searchBtn.disabled = false;
        searchBtn.innerHTML = 'S√∏k';
    }
}

function displaySearchResults(courses) {
    var html = '<h4>S√∏keresultater:</h4>';
    
    courses.forEach(function(course, index) {
        html += `<div class="course-result-item" onclick="selectCourseFromSearch(${index})">`;
        html += `<div style="font-weight: bold; font-size: 16px;">${course.club_name}</div>`;
        if (course.course_name && course.course_name !== course.club_name) {
            html += `<div style="font-size: 14px; color: #4299e1;">${course.course_name}</div>`;
        }
        html += `<div style="color: #718096; font-size: 13px;">${course.location.city}, ${course.location.country}</div>`;
        html += '</div>';
    });
    
    document.getElementById('searchResults').innerHTML = html;
}

async function selectCourseFromSearch(index) {
    var course = currentSearchResults[index];
    
    if (!course) {
        console.error('No course found at index:', index);
        document.getElementById('selectedCourseDetails').innerHTML = 
            '<div style="color: red; padding: 15px;">Feil: Ingen bane funnet</div>';
        return;
    }
    
    // Highlight selected course
    document.querySelectorAll('.course-result-item').forEach(function(item, i) {
        item.classList.toggle('selected', i === index);
    });
    
    console.log('Using search result data for:', course.club_name);
    console.log('Course data:', course);
    
    // Use the course data directly from search results instead of making another API call
    selectedCourseData = course;
    displayCourseDetails(course);
}

function displayCourseDetails(course) {
    console.log('displayCourseDetails called with:', course);
    
    if (!course) {
        console.error('displayCourseDetails called with undefined course');
        document.getElementById('selectedCourseDetails').innerHTML = 
            '<div style="color: red; padding: 15px;">Feil: Ingen banedata mottatt</div>';
        return;
    }
    
    var html = `<div style="margin-top: 20px; padding: 20px; background: #f0fdf4; border-radius: 10px;">`;
    html += `<h4>${course.club_name || 'Unknown Course'}`;
    if (course.course_name && course.course_name !== course.club_name) {
        html += ` - ${course.course_name}`;
    }
    html += `</h4>`;
    
    // Safely handle location data
    if (course.location) {
        var locationParts = [];
        if (course.location.address) locationParts.push(course.location.address);
        else {
            if (course.location.city) locationParts.push(course.location.city);
            if (course.location.state) locationParts.push(course.location.state);
            if (course.location.country) locationParts.push(course.location.country);
        }
        if (locationParts.length > 0) {
            html += `<p style="color: #718096; margin-bottom: 15px;">${locationParts.join(', ')}</p>`;
        }
    }
    
    // Debug tees structure
    console.log('Course tees structure:', course.tees);
    
    // Properly handle tees - avoid ES6 spread syntax
    var allTees = [];
    if (course.tees) {
        if (course.tees.male && Array.isArray(course.tees.male)) {
            console.log('Found male tees:', course.tees.male.length);
            allTees = allTees.concat(course.tees.male);
        }
        if (course.tees.female && Array.isArray(course.tees.female)) {
            console.log('Found female tees:', course.tees.female.length);
            allTees = allTees.concat(course.tees.female);
        }
    } else {
        console.log('No tees object found in course data');
    }
    
    console.log('Total tees found:', allTees.length);
    console.log('All tees:', allTees);
    
    if (allTees.length > 0) {
        html += '<h5>Velg tee:</h5>';
        html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin: 15px 0;">';
        
        allTees.forEach(function(tee, index) {
            console.log('Processing tee', index, ':', tee);
            
            // Escape JSON for HTML attribute
            var teeDataString = JSON.stringify(tee).replace(/"/g, '&quot;');
            
            html += `<div style="background: white; border: 2px solid #e2e8f0; border-radius: 8px; padding: 12px; cursor: pointer; transition: all 0.3s;" onclick="selectTee(${index}, '${teeDataString}')" id="tee_${index}">`;
            html += `<div style="font-weight: bold; margin-bottom: 5px;">${tee.tee_name || 'Unknown Tee'}</div>`;
            html += `<div style="font-size: 12px; color: #718096;">`;
            html += `Par: ${tee.par_total || 'N/A'}`;
            if (tee.slope_rating) html += ` | Slope: ${tee.slope_rating}`;
            html += `<br>`;
            if (tee.total_yards) html += `${tee.total_yards} yards`;
            if (tee.course_rating) html += ` | Rating: ${tee.course_rating}`;
            html += `</div>`;
            html += '</div>';
        });
        
        html += '</div>';
        html += '<div style="margin-top: 15px;">';
        html += '<button onclick="confirmCourseSelection()" style="background: #48bb78;" id="confirmBtn" disabled>Bekreft valg</button>';
        html += '<button onclick="hideCourseSearch()" style="background: #718096; margin-left: 10px;">Avbryt</button>';
        html += '</div>';
    } else {
        html += '<p style="color: #e53e3e;">Ingen tee-data tilgjengelig for denne banen.</p>';
        html += '<div style="margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 5px; font-size: 12px;">';
        html += '<strong>Debug info:</strong><br>';
        html += 'Course has tees object: ' + (course.tees ? 'Yes' : 'No') + '<br>';
        if (course.tees) {
            html += 'Male tees: ' + (course.tees.male ? course.tees.male.length : 'None') + '<br>';
            html += 'Female tees: ' + (course.tees.female ? course.tees.female.length : 'None');
        }
        html += '</div>';
    }
    
    html += '</div>';
    document.getElementById('selectedCourseDetails').innerHTML = html;
}

function selectTee(teeIndex, teeDataString) {
    // Remove selection from other tees
    document.querySelectorAll('[id^="tee_"]').forEach(function(tee) {
        tee.style.borderColor = '#e2e8f0';
        tee.style.background = 'white';
    });
    
    // Highlight selected tee
    var selectedTee = document.getElementById('tee_' + teeIndex);
    selectedTee.style.borderColor = '#48bb78';
    selectedTee.style.background = '#f0fdf4';
    
    // Parse tee data (handle escaped quotes)
    selectedTeeData = JSON.parse(teeDataString.replace(/&quot;/g, '"'));
    
    // Enable confirm button
    document.getElementById('confirmBtn').disabled = false;
}

function confirmCourseSelection() {
    if (!selectedCourseForRound || !selectedTeeData || !selectedCourseData) return;
    
    var round = schedule.find(function(r) { return r.id === selectedCourseForRound; });
    if (round) {
        // Update round with course information
        round.course = selectedCourseData.course_name || selectedCourseData.club_name;
        round.courseId = selectedCourseData.id;
        round.teeData = selectedTeeData;
        
        // Update courses object with API data - handle the actual API structure
        var courseName = round.course;
        var pars = [];
        var handicaps = [];
        
        // API uses 'holes' array (confirmed from your JSON example)
        if (selectedTeeData.holes && Array.isArray(selectedTeeData.holes)) {
            pars = selectedTeeData.holes.map(function(hole) { return hole.par || 4; });
            handicaps = selectedTeeData.holes.map(function(hole) { return hole.handicap || 1; });
        } else {
            // Default 18-hole course if no hole data available
            pars = [4,3,4,5,4,3,4,4,5,4,4,3,5,4,3,4,4,4]; // Standard par layout
            handicaps = [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18]; // Default handicap order
        }
        
        courses[courseName] = {
            slopeRating: selectedTeeData.slope_rating || 113,
            par: selectedTeeData.par_total || pars.reduce(function(a, b) { return a + b; }, 0),
            pars: pars,
            handicaps: handicaps
        };
        
        console.log('Course created:', courses[courseName]); // Debug log
        
        saveToServer();
        alert('Bane valgt: ' + courseName);
        hideCourseSearch();
        loadAdmin(); // Refresh admin view
    }
}

function addNewRound() {
    var newId = Math.max(...schedule.map(function(r) { return r.id; })) + 1;
    var newRound = {
        id: newId,
        date: 'Ny dato',
        time: 'Ny tid',
        course: '',
        courseId: null,
        teeData: null,
        type: 'Individuell',
        longestDrive: [],
        closestToPin: [],
        flights: [
            { time: '', players: [] }
        ]
    };
    
    schedule.push(newRound);
    saveToServer();
    loadAdmin();
}

function updateRound(roundId) {
    // This would allow editing round details
    alert('Runde oppdatering ikke implementert enn√•');
}

function deleteRound(roundId) {
    if (confirm('Er du sikker p√• at du vil slette denne runden?')) {
        schedule = schedule.filter(function(r) { return r.id !== roundId; });
        saveToServer();
        loadAdmin();
    }
}

// Schedule view functions
function loadSchedule() {
    var html = '<div style="margin-bottom: 20px;">';
    html += '<h3>Turneringsplan 2025</h3>';
    html += '<p style="color: #718096;">Oversikt over alle runder</p>';
    html += '</div>';
    
    schedule.forEach(function(round) {
        html += '<div class="hole-card">';
        html += '<h4>' + round.date + ' - ' + round.time + '</h4>';
        html += '<p><strong>Bane:</strong> ' + (round.course || 'Ikke valgt') + '</p>';
        html += '<p><strong>Type:</strong> ' + round.type + '</p>';
        
        if (round.type === 'Scramble' && round.teams) {
            html += '<h5>Lag:</h5>';
            round.teams.forEach(function(team, index) {
                var teamHandicap = calculateScrambleHandicap(team, round.course);
                html += '<div class="team-card">';
                html += '<strong>Lag ' + (index + 1) + ':</strong> ' + team.join(' & ');
                html += '<span style="float: right;">HCP: ' + teamHandicap + '</span>';
                html += '</div>';
            });
        }
        
        if (round.type === 'Individuell' && round.flights) {
            html += '<h5>Flight Tider:</h5>';
            round.flights.forEach(function(flight, index) {
                html += '<div style="background: #f8f9fa; padding: 10px; margin: 5px 0; border-radius: 5px;">';
                html += '<strong>Flight ' + (index + 1) + ':</strong> ' + (flight.time || 'Ikke satt');
                html += '<br><span style="color: #718096;">' + flight.players.join(', ') + '</span>';
                html += '</div>';
            });
        }
        
        if (round.longestDrive && round.longestDrive.length > 0) {
            html += '<p><strong>Longest Drive:</strong> Hull ' + round.longestDrive.join(', ') + '</p>';
        }
        if (round.closestToPin && round.closestToPin.length > 0) {
            html += '<p><strong>Closest to Pin:</strong> Hull ' + round.closestToPin.join(', ') + '</p>';
        }
        
        html += '</div>';
    });
    
    document.getElementById('scheduleContent').innerHTML = html;
}

// Scorecard view functions
function loadScorecard() {
    var html = '<div style="margin-bottom: 20px;">';
    html += '<h3>Registrer Score</h3>';
    html += '<p style="color: #718096;">Velg spiller og runde for √• registrere score</p>';
    html += '</div>';
    
    html += '<div style="background: #f7fafc; padding: 20px; border-radius: 10px; margin-bottom: 20px;">';
    html += '<div style="margin-bottom: 15px;">';
    html += '<label for="playerSelect"><strong>Velg Spiller:</strong></label>';
    html += '<select id="playerSelect" onchange="loadScorecardForm()">';
    html += '<option value="">-- Velg spiller --</option>';
    players.forEach(function(player) {
        html += '<option value="' + player.id + '">' + player.name + '</option>';
    });
    html += '</select>';
    html += '</div>';
    
    html += '<div style="margin-bottom: 15px;">';
    html += '<label for="roundSelect"><strong>Velg Runde:</strong></label>';
    html += '<select id="roundSelect" onchange="loadScorecardForm()">';
    html += '<option value="">-- Velg runde --</option>';
    schedule.forEach(function(round) {
        if (round.course) {
            html += '<option value="' + round.id + '">' + round.date + ' - ' + round.time + ' (' + round.course + ')</option>';
        }
    });
    html += '</select>';
    html += '</div>';
    html += '</div>';
    
    html += '<div id="scorecardForm"></div>';
    
    document.getElementById('scorecardContent').innerHTML = html;
}

function loadScorecardForm() {
    var playerId = document.getElementById('playerSelect').value;
    var roundId = document.getElementById('roundSelect').value;
    
    if (!playerId || !roundId) {
        document.getElementById('scorecardForm').innerHTML = '';
        return;
    }
    
    var player = players.find(function(p) { return p.id == playerId; });
    var round = schedule.find(function(r) { return r.id == roundId; });
    var course = courses[round.course];
    
    if (!player || !round || !course) {
        document.getElementById('scorecardForm').innerHTML = '<p style="color: red;">Feil ved lasting av data</p>';
        return;
    }
    
    var scoreKey = round.id + '_' + player.id;
    var existingScores = scores[scoreKey] || {};
    var courseHandicap = calculateCourseHandicap(player.handicap, round.course);
    
    var html = '<div style="background: white; padding: 20px; border-radius: 10px; border: 1px solid #e2e8f0;">';
    html += '<h4>' + player.name + ' - ' + round.course + '</h4>';
    html += '<p>Handicap: ' + player.handicap + ' | Banehandicap: ' + courseHandicap + '</p>';
    html += '<p style="color: #4299e1;">Beregningsmetode: ' + (useSlope ? 'Slope-basert' : 'Individuell') + '</p>';
    
    // Front 9
    html += '<h5 style="margin-top: 20px;">Front 9</h5>';
    html += '<div class="table-wrapper">';
    html += '<table>';
    html += '<thead><tr><th>Hull</th><th>Par</th><th>HCP</th><th>Slag</th><th>Score</th><th>Stableford</th></tr></thead>';
    html += '<tbody>';
    
    for (var i = 1; i <= 9; i++) {
        var par = course.pars[i-1];
        var strokes = getPlayerStrokes(courseHandicap, i, course);
        var score = existingScores[i] || '';
        var stableford = score ? calculateStableford(score, par + strokes) : '';
        
        html += '<tr>';
        html += '<td>' + i + '</td>';
        html += '<td>' + par + '</td>';
        html += '<td>' + strokes + '</td>';
        html += '<td style="background: ' + (strokes > 0 ? '#fef5e7' : 'white') + ';">' + (strokes > 0 ? '+' + strokes : '') + '</td>';
        html += '<td><input type="number" class="score-input" value="' + score + '" onchange="updateScore(' + round.id + ', ' + player.id + ', ' + i + ', this.value)" min="1" max="15"></td>';
        html += '<td>' + stableford + '</td>';
        html += '</tr>';
    }
    
    html += '</tbody></table>';
    html += '</div>';
    
    // Back 9
    html += '<h5 style="margin-top: 20px;">Back 9</h5>';
    html += '<div class="table-wrapper">';
    html += '<table>';
    html += '<thead><tr><th>Hull</th><th>Par</th><th>HCP</th><th>Slag</th><th>Score</th><th>Stableford</th></tr></thead>';
    html += '<tbody>';
    
    for (var i = 10; i <= 18; i++) {
        var par = course.pars[i-1];
        var strokes = getPlayerStrokes(courseHandicap, i, course);
        var score = existingScores[i] || '';
        var stableford = score ? calculateStableford(score, par + strokes) : '';
        
        html += '<tr>';
        html += '<td>' + i + '</td>';
        html += '<td>' + par + '</td>';
        html += '<td>' + strokes + '</td>';
        html += '<td style="background: ' + (strokes > 0 ? '#fef5e7' : 'white') + ';">' + (strokes > 0 ? '+' + strokes : '') + '</td>';
        html += '<td><input type="number" class="score-input" value="' + score + '" onchange="updateScore(' + round.id + ', ' + player.id + ', ' + i + ', this.value)" min="1" max="15"></td>';
        html += '<td>' + stableford + '</td>';
        html += '</tr>';
    }
    
    html += '</tbody></table>';
    html += '</div>';
    
    // Summary
    var totalStableford = 0;
    var totalStrokes = 0;
    var holesPlayed = 0;
    
    Object.keys(existingScores).forEach(function(hole) {
        var holeNum = parseInt(hole);
        var score = existingScores[hole];
        var par = course.pars[holeNum - 1];
        var strokes = getPlayerStrokes(courseHandicap, holeNum, course);
        
        totalStrokes += score;
        totalStableford += calculateStableford(score, par + strokes);
        holesPlayed++;
    });
    
    html += '<div style="margin-top: 20px; padding: 15px; background: #f0fdf4; border-radius: 8px;">';
    html += '<h5>Sammendrag</h5>';
    html += '<p>Hull spilt: ' + holesPlayed + '/18</p>';
    html += '<p>Totale slag: ' + (totalStrokes || 0) + '</p>';
    html += '<p>Stableford poeng: ' + totalStableford + '</p>';
    html += '</div>';
    
    html += '</div>';
    
    document.getElementById('scorecardForm').innerHTML = html;
}

function updateScore(roundId, playerId, hole, score) {
    var scoreKey = roundId + '_' + playerId;
    if (!scores[scoreKey]) {
        scores[scoreKey] = {};
    }
    
    if (score && score > 0) {
        scores[scoreKey][hole] = parseInt(score);
    } else {
        delete scores[scoreKey][hole];
    }
    
    saveToServer();
    // Refresh the form to update Stableford calculations
    setTimeout(function() {
        loadScorecardForm();
    }, 100);
}

function calculateStableford(score, adjustedPar) {
    var diff = adjustedPar - score;
    if (diff >= 2) return 4;      // Eagle or better
    if (diff === 1) return 3;     // Birdie
    if (diff === 0) return 2;     // Par
    if (diff === -1) return 1;    // Bogey
    return 0;                     // Double bogey or worse
}

// Players view functions
function loadPlayers() {
    var html = '<div style="margin-bottom: 20px;">';
    html += '<h3>Spillere og Handicap</h3>';
    html += '<p style="color: #718096;">Oversikt over alle deltakere</p>';
    html += '</div>';
    
    html += '<div class="table-wrapper">';
    html += '<table>';
    html += '<thead>';
    html += '<tr>';
    html += '<th>Spiller</th>';
    html += '<th>Handicap</th>';
    Object.keys(courses).forEach(function(courseName) {
        html += '<th>' + courseName + '</th>';
    });
    html += '</tr>';
    html += '</thead>';
    html += '<tbody>';
    
    players.forEach(function(player) {
        html += '<tr>';
        html += '<td><strong>' + player.name + '</strong></td>';
        html += '<td>' + player.handicap + '</td>';
        
        Object.keys(courses).forEach(function(courseName) {
            var courseHandicap = calculateCourseHandicap(player.handicap, courseName);
            html += '<td>' + courseHandicap + '</td>';
        });
        
        html += '</tr>';
    });
    
    html += '</tbody>';
    html += '</table>';
    html += '</div>';
    
    // Show scramble teams and handicaps
    html += '<div style="margin-top: 30px;">';
    html += '<h4>Scramble Lag og Handicap</h4>';
    html += '<p style="color: #718096;">Aktuell formel: ' + getScrambleFormulaText() + '</p>';
    
    schedule.forEach(function(round) {
        if (round.type === 'Scramble' && round.teams && round.course) {
            html += '<div style="background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 8px;">';
            html += '<h5>' + round.date + ' - ' + round.course + '</h5>';
            
            round.teams.forEach(function(team, index) {
                var teamHandicap = calculateScrambleHandicap(team, round.course);
                html += '<div style="background: white; padding: 10px; margin: 5px 0; border-radius: 5px; border-left: 4px solid #4299e1;">';
                html += '<strong>Lag ' + (index + 1) + ':</strong> ' + team.join(' & ');
                html += '<span style="float: right; color: #4299e1;">Handicap: ' + teamHandicap + '</span>';
                html += '</div>';
            });
            
            html += '</div>';
        }
    });
    
    html += '</div>';
    
    document.getElementById('playersContent').innerHTML = html;
}

function getScrambleFormulaText() {
    switch(scrambleFormula) {
        case 'standard': return 'Standard (35% lavest + 15% h√∏yest)';
        case 'usga': return 'USGA (50% lavest + 10% h√∏yest)';
        case 'custom': return 'Tilpasset (70% lavest + 30% h√∏yest)';
        default: return 'Standard';
    }
}

// Leaderboard view functions
function loadLeaderboard() {
    var html = '<div style="margin-bottom: 20px;">';
    html += '<h3>Resultatliste</h3>';
    html += '<p style="color: #718096;">Live stilling og resultater</p>';
    html += '</div>';
    
    // Overall standings
    html += '<div style="background: #f0fdf4; padding: 20px; border-radius: 10px; margin-bottom: 20px;">';
    html += '<h4>üèÜ Sammenlagt Stilling</h4>';
    
    var overallStandings = calculateOverallStandings();
    
    if (overallStandings.length > 0) {
        html += '<div class="table-wrapper">';
        html += '<table>';
        html += '<thead><tr><th>Pos</th><th>Spiller</th><th>Poeng</th><th>Runder</th></tr></thead>';
        html += '<tbody>';
        
        overallStandings.forEach(function(standing, index) {
            html += '<tr>';
            html += '<td>' + (index + 1);
            if (index === 0) html += ' ü•á';
            else if (index === 1) html += ' ü•à';
            else if (index === 2) html += ' ü•â';
            html += '</td>';
            html += '<td><strong>' + standing.player + '</strong></td>';
            html += '<td>' + standing.totalPoints + '</td>';
            html += '<td>' + standing.roundsPlayed + '</td>';
            html += '</tr>';
        });
        
        html += '</tbody></table>';
        html += '</div>';
    } else {
        html += '<p style="color: #718096;">Ingen resultater registrert enn√•</p>';
    }
    
    html += '</div>';
    
    // Round by round results
    html += '<h4>Resultater per Runde</h4>';
    
    schedule.forEach(function(round) {
        if (round.course) {
            html += '<div style="background: white; padding: 20px; border-radius: 10px; margin: 15px 0; border: 1px solid #e2e8f0;">';
            html += '<h5>' + round.date + ' - ' + round.time + ' (' + round.course + ')</h5>';
            
            if (round.type === 'Individuell') {
                var roundResults = calculateRoundResults(round.id);
                
                if (roundResults.length > 0) {
                    html += '<div class="table-wrapper">';
                    html += '<table>';
                    html += '<thead><tr><th>Pos</th><th>Spiller</th><th>Poeng</th><th>Hull</th></tr></thead>';
                    html += '<tbody>';
                    
                    roundResults.forEach(function(result, index) {
                        html += '<tr>';
                        html += '<td>' + (index + 1);
                        if (index === 0) html += ' üèÜ';
                        html += '</td>';
                        html += '<td>' + result.player + '</td>';
                        html += '<td>' + result.points + '</td>';
                        html += '<td>' + result.holesPlayed + '/18</td>';
                        html += '</tr>';
                    });
                    
                    html += '</tbody></table>';
                    html += '</div>';
                } else {
                    html += '<p style="color: #718096;">Ingen scorer registrert</p>';
                }
                
                // Competition winners
                if (round.longestDrive && round.longestDrive.length > 0) {
                    html += '<div style="margin-top: 15px;">';
                    html += '<h6>üèåÔ∏è Longest Drive</h6>';
                    round.longestDrive.forEach(function(hole) {
                        var winner = awards[round.id + '_longest_' + hole] || 'Ikke valgt';
                        html += '<p>Hull ' + hole + ': <strong>' + winner + '</strong></p>';
                    });
                    html += '</div>';
                }
                
                if (round.closestToPin && round.closestToPin.length > 0) {
                    html += '<div style="margin-top: 15px;">';
                    html += '<h6>üéØ Closest to Pin</h6>';
                    round.closestToPin.forEach(function(hole) {
                        var winner = awards[round.id + '_closest_' + hole] || 'Ikke valgt';
                        html += '<p>Hull ' + hole + ': <strong>' + winner + '</strong></p>';
                    });
                    html += '</div>';
                }
            } else {
                // Scramble results
                html += '<p style="color: #4299e1;">Scramble resultater kommer snart</p>';
            }
            
            html += '</div>';
        }
    });
    
    document.getElementById('leaderboardContent').innerHTML = html;
}

function calculateOverallStandings() {
    var standings = {};
    
    // Initialize all players
    players.forEach(function(player) {
        standings[player.name] = {
            player: player.name,
            totalPoints: 0,
            roundsPlayed: 0
        };
    });
    
    // Calculate points from all individual rounds
    schedule.forEach(function(round) {
        if (round.type === 'Individuell' && round.course) {
            players.forEach(function(player) {
                var scoreKey = round.id + '_' + player.id;
                var playerScores = scores[scoreKey];
                
                if (playerScores && Object.keys(playerScores).length > 0) {
                    var roundPoints = 0;
                    var course = courses[round.course];
                    var courseHandicap = calculateCourseHandicap(player.handicap, round.course);
                    
                    Object.keys(playerScores).forEach(function(hole) {
                        var holeNum = parseInt(hole);
                        var score = playerScores[hole];
                        var par = course.pars[holeNum - 1];
                        var strokes = getPlayerStrokes(courseHandicap, holeNum, course);
                        var adjustedPar = par + strokes;
                        
                        roundPoints += calculateStableford(score, adjustedPar);
                    });
                    
                    standings[player.name].totalPoints += roundPoints;
                    standings[player.name].roundsPlayed++;
                }
            });
        }
    });
    
    // Convert to array and sort
    return Object.values(standings)
        .filter(function(standing) { return standing.roundsPlayed > 0; })
        .sort(function(a, b) { return b.totalPoints - a.totalPoints; });
}

function calculateRoundResults(roundId) {
    var results = [];
    
    players.forEach(function(player) {
        var scoreKey = roundId + '_' + player.id;
        var playerScores = scores[scoreKey];
        
        if (playerScores && Object.keys(playerScores).length > 0) {
            var roundPoints = 0;
            var holesPlayed = Object.keys(playerScores).length;
            var round = schedule.find(function(r) { return r.id == roundId; });
            var course = courses[round.course];
            var courseHandicap = calculateCourseHandicap(player.handicap, round.course);
            
            Object.keys(playerScores).forEach(function(hole) {
                var holeNum = parseInt(hole);
                var score = playerScores[hole];
                var par = course.pars[holeNum - 1];
                var strokes = getPlayerStrokes(courseHandicap, holeNum, course);
                var adjustedPar = par + strokes;
                
                roundPoints += calculateStableford(score, adjustedPar);
            });
            
            results.push({
                player: player.name,
                points: roundPoints,
                holesPlayed: holesPlayed
            });
        }
    });
    
    return results.sort(function(a, b) { return b.points - a.points; });
}

// Courses view functions
function loadCourses() {
    var html = '<div style="margin-bottom: 20px;">';
    html += '<h3>Scorekort per Bane</h3>';
    html += '<p style="color: #718096;">Detaljerte scorekort for alle baner</p>';
    html += '</div>';
    
    Object.keys(courses).forEach(function(courseName) {
        var course = courses[courseName];
        
        html += '<div style="background: white; padding: 20px; border-radius: 10px; margin: 15px 0; border: 1px solid #e2e8f0;">';
        html += '<h4>' + courseName + '</h4>';
        html += '<p>Par: ' + course.par + ' | Slope: ' + course.slopeRating + '</p>';
        
        // Front 9
        html += '<h5 style="margin-top: 20px;">Front 9</h5>';
        html += '<div class="table-wrapper">';
        html += '<table>';
        html += '<thead><tr><th>Hull</th><th>Par</th><th>HCP</th>';
        players.forEach(function(player) {
            html += '<th>' + player.name + '</th>';
        });
        html += '</tr></thead>';
        html += '<tbody>';
        
        for (var i = 1; i <= 9; i++) {
            html += '<tr>';
            html += '<td>' + i + '</td>';
            html += '<td>' + course.pars[i-1] + '</td>';
            html += '<td>' + course.handicaps[i-1] + '</td>';
            
            players.forEach(function(player) {
                var roundScore = getPlayerScoreForCourse(player.id, courseName, i);
                var courseHandicap = calculateCourseHandicap(player.handicap, courseName);
                var strokes = getPlayerStrokes(courseHandicap, i, course);
                
                html += '<td style="background: ' + (strokes > 0 ? '#fef5e7' : 'white') + ';">';
                if (roundScore) {
                    html += roundScore;
                    if (strokes > 0) html += ' (' + strokes + ')';
                } else {
                    html += '-';
                }
                html += '</td>';
            });
            
            html += '</tr>';
        }
        
        html += '</tbody></table>';
        html += '</div>';
        
        // Back 9
        html += '<h5 style="margin-top: 20px;">Back 9</h5>';
        html += '<div class="table-wrapper">';
        html += '<table>';
        html += '<thead><tr><th>Hull</th><th>Par</th><th>HCP</th>';
        players.forEach(function(player) {
            html += '<th>' + player.name + '</th>';
        });
        html += '</tr></thead>';
        html += '<tbody>';
        
        for (var i = 10; i <= 18; i++) {
            html += '<tr>';
            html += '<td>' + i + '</td>';
            html += '<td>' + course.pars[i-1] + '</td>';
            html += '<td>' + course.handicaps[i-1] + '</td>';
            
            players.forEach(function(player) {
                var roundScore = getPlayerScoreForCourse(player.id, courseName, i);
                var courseHandicap = calculateCourseHandicap(player.handicap, courseName);
                var strokes = getPlayerStrokes(courseHandicap, i, course);
                
                html += '<td style="background: ' + (strokes > 0 ? '#fef5e7' : 'white') + ';">';
                if (roundScore) {
                    html += roundScore;
                    if (strokes > 0) html += ' (' + strokes + ')';
                } else {
                    html += '-';
                }
                html += '</td>';
            });
            
            html += '</tr>';
        }
        
        html += '</tbody></table>';
        html += '</div>';
        
        html += '</div>';
    });
    
    document.getElementById('coursesContent').innerHTML = html;
}

function getPlayerScoreForCourse(playerId, courseName, hole) {
    // Find rounds played on this course
    var courseRounds = schedule.filter(function(round) {
        return round.course === courseName && round.type === 'Individuell';
    });
    
    for (var i = 0; i < courseRounds.length; i++) {
        var round = courseRounds[i];
        var scoreKey = round.id + '_' + playerId;
        var playerScores = scores[scoreKey];
        
        if (playerScores && playerScores[hole]) {
            return playerScores[hole];
        }
    }
    
    return null;
}

// History view functions
function loadHistory() {
    var html = '<div style="margin-bottom: 20px;">';
    html += '<h3>Spillte Baner Gjennom √Örene</h3>';
    html += '<p style="color: #718096;">Historisk oversikt over alle bes√∏kte golfbaner</p>';
    html += '</div>';
    
    // Statistics
    var totalCourses = playedCourses.length;
    var totalRounds = playedCourses.reduce(function(sum, course) {
        return sum + course.years.length;
    }, 0);
    
    html += '<div style="background: #f0fdf4; padding: 20px; border-radius: 10px; margin-bottom: 20px;">';
    html += '<h4>üìä Statistikk</h4>';
    html += '<p><strong>Totalt antall baner:</strong> ' + totalCourses + '</p>';
    html += '<p><strong>Totalt antall runder:</strong> ' + totalRounds + '</p>';
    html += '<p><strong>F√∏rste tur:</strong> 2010</p>';
    html += '<p><strong>√Ör med golf:</strong> ' + (new Date().getFullYear() - 2010 + 1) + ' √•r</p>';
    html += '</div>';
    
    // Course list
    html += '<h4>Alle Spillte Baner</h4>';
    html += '<div class="table-wrapper">';
    html += '<table>';
    html += '<thead>';
    html += '<tr>';
    html += '<th>Bane</th>';
    html += '<th>√Ör Spilt</th>';
    html += '<th>Antall Ganger</th>';
    html += '</tr>';
    html += '</thead>';
    html += '<tbody>';
    
    playedCourses.forEach(function(course) {
        html += '<tr>';
        html += '<td><strong>' + course.name + '</strong></td>';
        html += '<td>' + course.years.join(', ') + '</td>';
        html += '<td>' + course.years.length + '</td>';
        html += '</tr>';
    });
    
    html += '</tbody>';
    html += '</table>';
    html += '</div>';
    
    document.getElementById('historyContent').innerHTML = html;
}

// Whisky view functions
function loadWhisky() {
    var html = '<div style="margin-bottom: 20px;">';
    html += '<h3>ü•É Whisky Samlingen</h3>';
    html += '<p style="color: #718096;">Oversikt over alle whisky valg</p>';
    html += '</div>';
    
    html += '<div class="table-wrapper">';
    html += '<table>';
    html += '<thead>';
    html += '<tr>';
    html += '<th>Spiller</th>';
    html += '<th>Prim√¶r Whisky</th>';
    html += '<th>Reserve Whisky</th>';
    html += '<th>Status</th>';
    html += '</tr>';
    html += '</thead>';
    html += '<tbody>';
    
    whiskyCollection.forEach(function(entry) {
        var status = '';
        if (entry.primary && entry.reserve) {
            status = '‚úÖ Komplett';
        } else if (entry.primary) {
            status = '‚ö†Ô∏è Trenger reserve';
        } else {
            status = '‚ùå Ikke valgt';
        }
        
        html += '<tr>';
        html += '<td><strong>' + entry.player + '</strong></td>';
        html += '<td>' + (entry.primary || '-') + '</td>';
        html += '<td>' + (entry.reserve || '-') + '</td>';
        html += '<td>' + status + '</td>';
        html += '</tr>';
    });
    
    html += '</tbody>';
    html += '</table>';
    html += '</div>';
    
    // Summary
    var complete = whiskyCollection.filter(function(e) { return e.primary && e.reserve; }).length;
    var partial = whiskyCollection.filter(function(e) { return e.primary && !e.reserve; }).length;
    var missing = whiskyCollection.filter(function(e) { return !e.primary; }).length;
    
    html += '<div style="margin-top: 20px; padding: 20px; background: #f7fafc; border-radius: 10px;">';
    html += '<h4>Sammendrag</h4>';
    html += '<p>‚úÖ Komplette valg: ' + complete + '/' + whiskyCollection.length + '</p>';
    html += '<p>‚ö†Ô∏è Trenger reserve: ' + partial + '</p>';
    html += '<p>‚ùå Ikke valgt: ' + missing + '</p>';
    html += '</div>';
    
    document.getElementById('whiskyContent').innerHTML = html;
}

// Yearly Results view functions
function loadYearlyResults() {
    var html = '<div style="margin-bottom: 20px;">';
    html += '<h3>üìä √Örsresultater</h3>';
    html += '<p style="color: #718096;">Resultater fra alle turneringer</p>';
    html += '</div>';
    
    // Current year results
    html += '<div style="background: #f0fdf4; padding: 20px; border-radius: 10px; margin-bottom: 20px;">';
    html += '<h4>üèÜ ' + currentYear + ' Resultater</h4>';
    
    var currentYearStandings = calculateOverallStandings();
    
    if (currentYearStandings.length > 0) {
        html += '<div class="table-wrapper">';
        html += '<table>';
        html += '<thead><tr><th>Pos</th><th>Spiller</th><th>Poeng</th><th>Runder</th></tr></thead>';
        html += '<tbody>';
        
        currentYearStandings.forEach(function(standing, index) {
            html += '<tr>';
            html += '<td>' + (index + 1);
            if (index === 0) html += ' üëë';
            html += '</td>';
            html += '<td><strong>' + standing.player + '</strong></td>';
            html += '<td>' + standing.totalPoints + '</td>';
            html += '<td>' + standing.roundsPlayed + '</td>';
            html += '</tr>';
        });
        
        html += '</tbody></table>';
        html += '</div>';
    } else {
        html += '<p style="color: #718096;">Ingen resultater registrert enn√• for ' + currentYear + '</p>';
    }
    
    html += '</div>';
    
    // Historical winners (placeholder data)
    html += '<h4>Historiske Vinnere</h4>';
    html += '<div style="background: white; padding: 20px; border-radius: 10px; border: 1px solid #e2e8f0;">';
    
    var historicalWinners = [
        { year: 2024, winner: 'Klaus', points: 156 },
        { year: 2023, winner: 'Ruben', points: 148 },
        { year: 2022, winner: 'Dag', points: 142 },
        { year: 2021, winner: 'Roar', points: 139 },
        { year: 2020, winner: 'Klaus', points: 145 }
    ];
    
    html += '<div class="table-wrapper">';
    html += '<table>';
    html += '<thead><tr><th>√Ör</th><th>Vinner</th><th>Poeng</th></tr></thead>';
    html += '<tbody>';
    
    historicalWinners.forEach(function(winner) {
        html += '<tr>';
        html += '<td>' + winner.year + '</td>';
        html += '<td><strong>' + winner.winner + '</strong></td>';
        html += '<td>' + winner.points + '</td>';
        html += '</tr>';
    });
    
    html += '</tbody></table>';
    html += '</div>';
    
    html += '</div>';
    
    document.getElementById('yearlyResultsContent').innerHTML = html;
}

// Data persistence functions
async function saveToServer() {
    var data = {
        currentYear: currentYear,
        language: language,
        isAdmin: isAdmin,
        useSlope: useSlope,
        scrambleFormula: scrambleFormula,
        players: players,
        schedule: schedule,
        courses: courses,
        scores: scores,
        scrambleScores: scrambleScores,
        awards: awards,
        flightTimes: flightTimes,
        whiskyCollection: whiskyCollection,
        playedCourses: playedCourses,
        timestamp: new Date().toISOString()
    };
    
    // Save to localStorage as backup
    localStorage.setItem('golfApp2025', JSON.stringify(data));
    
    try {
        // Attempt to save to server
        var response = await fetch('/api/save-golf-data', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            console.log('Data saved to server successfully');
        } else {
            console.warn('Server save failed, using localStorage only');
        }
    } catch (error) {
        console.warn('Server not available, using localStorage only:', error);
    }
}

async function loadFromServer() {
    try {
        // Try to load from server first
        var response = await fetch('/api/load-golf-data');
        
        if (response.ok) {
            var serverData = await response.json();
            if (serverData && serverData.timestamp) {
                applyLoadedData(serverData);
                console.log('Data loaded from server');
                return;
            }
        }
    } catch (error) {
        console.warn('Server not available, trying localStorage:', error);
    }
    
    // Fallback to localStorage
    var localData = localStorage.getItem('golfApp2025');
    if (localData) {
        try {
            var parsedData = JSON.parse(localData);
            applyLoadedData(parsedData);
            console.log('Data loaded from localStorage');
        } catch (error) {
            console.error('Error parsing localStorage data:', error);
        }
    }
}

function applyLoadedData(data) {
    if (data.currentYear) currentYear = data.currentYear;
    if (data.language) language = data.language;
    if (data.isAdmin !== undefined) isAdmin = data.isAdmin;
    if (data.useSlope !== undefined) useSlope = data.useSlope;
    if (data.scrambleFormula) scrambleFormula = data.scrambleFormula;
    if (data.players) players = data.players;
    if (data.schedule) schedule = data.schedule;
    if (data.courses) courses = data.courses;
    if (data.scores) scores = data.scores;
    if (data.scrambleScores) scrambleScores = data.scrambleScores;
    if (data.awards) awards = data.awards;
    if (data.flightTimes) flightTimes = data.flightTimes;
    if (data.whiskyCollection) whiskyCollection = data.whiskyCollection;
    if (data.playedCourses) playedCourses = data.playedCourses;
    
    // Update UI
    updateLanguageText();
}

// Initialize app
document.addEventListener('DOMContentLoaded', function() {
    loadFromServer().then(function() {
        updateLanguageText();
        console.log('Scotland Golf 2025 app initialized');
    });
    
    // Auto-save every 30 seconds
    setInterval(function() {
        saveToServer();
    }, 30000);
});

// Global function assignments for onclick handlers
window.showView = showView;
window.toggleLanguage = toggleLanguage;
window.toggleSection = toggleSection;
window.performCourseSearch = performCourseSearch;
window.hideCourseSearch = hideCourseSearch;
window.loginAdmin = loginAdmin;
window.logoutAdmin = logoutAdmin;
window.showCourseSearch = showCourseSearch;
window.selectCourseFromSearch = selectCourseFromSearch;
window.selectTee = selectTee;
window.confirmCourseSelection = confirmCourseSelection;
window.addNewRound = addNewRound;
window.updateRound = updateRound;
window.deleteRound = deleteRound;
window.toggleHandicapMethod = toggleHandicapMethod;
window.changeScrambleFormula = changeScrambleFormula;
window.updateHandicap = updateHandicap;
window.saveHandicaps = saveHandicaps;
window.updateFlightTime = updateFlightTime;
window.saveFlightTimes = saveFlightTimes;
window.updateCompetitionHoles = updateCompetitionHoles;
window.saveCompetitionHoles = saveCompetitionHoles;
window.updateAward = updateAward;
window.saveAwards = saveAwards;
window.saveWhisky = saveWhisky;
window.loadScorecardForm = loadScorecardForm;
window.updateScore = updateScore;

</script>
</body>
</html>
