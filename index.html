<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scotland Golf 2025</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .header h1 {
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 24px;
        }
        
        .header p {
            color: #718096;
            font-size: 14px;
        }
        
        .lang-toggle {
            position: fixed;
            top: 10px;
            right: 10px;
            background: white;
            padding: 8px 15px;
            border-radius: 10px;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            font-size: 14px;
        }
        
        .version-badge {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            color: #718096;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .nav-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .nav-card {
            background: white;
            border-radius: 15px;
            padding: 20px 15px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .nav-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }
        
        .nav-card h3 {
            color: #2d3748;
            margin: 10px 0 5px;
            font-size: 16px;
        }
        
        .nav-card p {
            color: #718096;
            font-size: 12px;
        }
        
        .icon {
            font-size: 40px;
            line-height: 1.2;
            margin-bottom: 10px;
        }
        
        .content {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: none;
            max-width: 100%;
            overflow-x: auto;
        }
        
        .content.active {
            display: block;
        }
        
        .back-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 15px;
            font-size: 14px;
        }
        
        .back-btn:hover {
            background: #5a67d8;
        }
        
        .schedule-item {
            background: #f7fafc;
            border-left: 4px solid #48bb78;
            padding: 12px;
            margin-bottom: 12px;
            border-radius: 0 8px 8px 0;
            font-size: 14px;
        }
        
        .handicap-info {
            background: #e6f4ff;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 14px;
        }
        
        .scramble-handicap-info {
            background: #f0f9ff;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 2px solid #0ea5e9;
        }
        
        .scramble-handicap-info h5 {
            color: #0c4a6e;
            margin-bottom: 10px;
        }
        
        .stroke-toggle {
            margin: 10px 0;
        }
        
        .stroke-display {
            margin-top: 10px;
            padding: 10px;
            background: #fef3c7;
            border-radius: 5px;
            font-size: 12px;
        }
        
        .stroke-display .hole-stroke {
            display: inline-block;
            margin: 2px;
            padding: 3px 6px;
            background: #fbbf24;
            border-radius: 3px;
            color: white;
            font-weight: bold;
        }
        
        .flight-section {
            background: #edf2f7;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .flight-item {
            background: white;
            padding: 8px;
            margin: 5px 0;
            border-radius: 5px;
            font-size: 13px;
        }
        
        .player-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .player-card {
            background: #f7fafc;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #e2e8f0;
            font-size: 14px;
        }
        
        .player-card h4 {
            color: #2d3748;
            margin-bottom: 8px;
            font-size: 16px;
        }
        
        .player-card p {
            color: #718096;
            font-size: 12px;
            margin: 3px 0;
        }
        
        .scorecard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 8px;
            margin: 15px 0;
        }
        
        .hole-input {
            background: #f7fafc;
            padding: 12px;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
            position: relative;
        }
        
        .hole-input.stroke {
            background: #fef5e7;
            border-color: #f6d55c;
        }
        
        .hole-input label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #2d3748;
            font-size: 12px;
        }
        
        .hole-input input {
            width: 100%;
            padding: 6px;
            border: 1px solid #cbd5e0;
            border-radius: 5px;
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .pickup-btn {
            width: 100%;
            background: #e53e3e;
            color: white;
            border: none;
            padding: 4px 6px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
            transition: background 0.2s;
        }
        
        .pickup-btn:hover {
            background: #c53030;
        }
        
        .pickup-score {
            background: #fed7d7 !important;
            border-color: #e53e3e !important;
        }
        
        .pickup-score input {
            background: #fed7d7;
            color: #c53030;
            font-weight: bold;
        }
        
        button {
            background: #48bb78;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        
        button:hover {
            background: #38a169;
        }
        
        .round-select, .team-select {
            background: #f7fafc;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            cursor: pointer;
            border: 2px solid #e2e8f0;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        
        .round-select:hover, .team-select:hover {
            background: #edf2f7;
        }
        
        select, input[type="text"], input[type="number"], input[type="time"], input[type="password"] {
            padding: 8px;
            border: 1px solid #cbd5e0;
            border-radius: 5px;
            font-size: 14px;
            width: 100%;
            margin: 5px 0;
        }
        
        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin: 10px 0;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        
        th, td {
            padding: 8px 5px;
            text-align: center;
            border: 1px solid #e2e8f0;
            white-space: nowrap;
        }
        
        th {
            background: #f7fafc;
            font-weight: bold;
            color: #2d3748;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        td:first-child, th:first-child {
            text-align: left;
            position: sticky;
            left: 0;
            background: white;
            z-index: 5;
            min-width: 80px;
            font-weight: bold;
        }
        
        th:first-child {
            background: #f7fafc;
            z-index: 11;
        }
        
        .success-message {
            background: #48bb78;
            color: white;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            text-align: center;
            font-size: 14px;
        }
        
        .overall-section {
            background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        
        .overall-section h3 {
            color: white;
            margin-bottom: 10px;
            font-size: 18px;
        }
        
        .overall-table {
            background: white;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .trophy {
            color: gold;
            margin-right: 5px;
        }
        
        .team-section {
            background: #edf2f7;
            padding: 10px;
            border-radius: 10px;
            margin: 10px 0;
            font-size: 14px;
        }

        .collapsible {
            background: #667eea;
            color: white;
            cursor: pointer;
            padding: 12px 15px;
            width: 100%;
            border: none;
            text-align: left;
            outline: none;
            font-size: 15px;
            border-radius: 8px;
            margin-top: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .collapsible:hover {
            background: #5a67d8;
        }

        .collapsible:after {
            content: '\002B';
            color: white;
            font-weight: bold;
            float: right;
            margin-left: 5px;
        }

        .collapsible.active:after {
            content: "\2212";
        }

        .collapsible-content {
            padding: 0 18px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.2s ease-out;
            background-color: #f7fafc;
            border-radius: 0 0 8px 8px;
            margin-bottom: 10px;
        }

        .collapsible-content.show {
            max-height: 2000px;
            padding: 18px;
            transition: max-height 0.3s ease-in;
        }
        
        .course-section {
            border-top: 3px solid #667eea;
            margin: 20px 0;
            padding-top: 15px;
        }
        
        .scramble-result {
            background: #e6fffa;
            border: 2px solid #38b2ac;
            padding: 8px;
            border-radius: 8px;
            margin: 8px 0;
            font-size: 14px;
        }
        
        .winner {
            background: #c6f6d5;
            border-color: #48bb78;
        }
        
        .admin-section {
            background: #fff5f5;
            border: 2px solid #fc8181;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }
        
        .admin-section h4 {
            color: #c53030;
            margin-bottom: 10px;
        }
        
        .award-select {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
            margin: 10px 0;
        }
        
        .award-input {
            background: white;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        
        .award-input label {
            display: block;
            font-size: 12px;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .handicap-edit-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        
        .handicap-edit-item {
            background: white;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        
        .handicap-edit-item label {
            display: block;
            font-size: 12px;
            margin-bottom: 5px;
            font-weight: bold;
            color: #2d3748;
        }
        
        .handicap-edit-item input {
            width: 100%;
            padding: 8px;
            border: 1px solid #cbd5e0;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .nine-section {
            margin-bottom: 20px;
        }
        
        .nine-section h5 {
            margin-bottom: 10px;
            color: #2d3748;
            font-size: 16px;
        }
        
        .year-results {
            background: #f7fafc;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }
        
        .course-edit-grid {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            gap: 5px;
            margin: 10px 0;
        }
        
        .course-edit-hole {
            text-align: center;
        }
        
        .course-edit-hole label {
            font-size: 11px;
            display: block;
            margin-bottom: 3px;
        }
        
        .course-edit-hole input {
            width: 100%;
            padding: 4px;
            font-size: 12px;
            text-align: center;
        }
        
        .flight-time-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        
        .flight-time-item {
            background: white;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        
        @media (max-width: 768px) {
            .nav-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .header h1 {
                font-size: 20px;
            }
            
            .nav-card h3 {
                font-size: 14px;
            }
            
            .nav-card p {
                font-size: 11px;
            }
            
            table {
                font-size: 11px;
            }
            
            th, td {
                padding: 5px 3px;
            }
            
            .scorecard-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .course-edit-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="lang-toggle" onclick="toggleLanguage()">
        <span id="langBtn">🇬🇧 EN</span>
    </div>

    <div class="version-badge">v6.0</div>

    <div class="container">
        <div class="header">
            <h1 id="appTitle">Scotland Golf 2025</h1>
            <p id="appSubtitle">Årlig golftur til Skottland</p>
        </div>
        
        <div id="homeView" class="view">
            <div class="nav-grid">
                <div class="nav-card" onclick="showView('schedule')">
                    <div class="icon">📅</div>
                    <h3 id="scheduleTitle">Timeplan</h3>
                    <p id="scheduleDesc">Se runder</p>
                </div>
                
                <div class="nav-card" onclick="showView('scorecard')">
                    <div class="icon">⛳</div>
                    <h3 id="scorecardTitle">Registrer</h3>
                    <p id="scorecardDesc">Legg inn score</p>
                </div>
                
                <div class="nav-card" onclick="showView('leaderboard')">
                    <div class="icon">🏆</div>
                    <h3 id="leaderboardTitle">Resultater</h3>
                    <p id="leaderboardDesc">Live stilling</p>
                </div>
                
                <div class="nav-card" onclick="showView('courses')">
                    <div class="icon">🏌</div>
                    <h3 id="coursesTitle">Baner</h3>
                    <p id="coursesDesc">Scorekort</p>
                </div>
                
                <div class="nav-card" onclick="showView('players')">
                    <div class="icon">👥</div>
                    <h3 id="playersTitle">Spillere</h3>
                    <p id="playersDesc">Handicap</p>
                </div>
                
                <div class="nav-card" onclick="showView('yearlyResults')">
                    <div class="icon">📊</div>
                    <h3 id="yearlyTitle">Årsresultater</h3>
                    <p id="yearlyDesc">Alle år</p>
                </div>
                
                <div class="nav-card" onclick="showView('history')">
                    <div class="icon">📚</div>
                    <h3 id="historyTitle">Historie</h3>
                    <p id="historyDesc">Spillte baner</p>
                </div>
                
                <div class="nav-card" onclick="showView('whisky')">
                    <div class="icon">🥃</div>
                    <h3 id="whiskyTitle">Whisky</h3>
                    <p id="whiskyDesc">Samlingen</p>
                </div>
                
                <div class="nav-card" onclick="showView('admin')">
                    <div class="icon">🔐</div>
                    <h3 id="adminTitle">Admin</h3>
                    <p id="adminDesc">Administrer</p>
                </div>
            </div>
        </div>
        
        <div id="scheduleView" class="content">
            <button class="back-btn" onclick="showView('home')">← Tilbake</button>
            <h2>Turneringsplan</h2>
            <div id="scheduleContent"></div>
        </div>
        
        <div id="scorecardView" class="content">
            <button class="back-btn" onclick="showView('home')">← Tilbake</button>
            <h2>Registrer Score</h2>
            <div id="scorecardContent"></div>
        </div>
        
        <div id="leaderboardView" class="content">
            <button class="back-btn" onclick="showView('home')">← Tilbake</button>
            <h2>Resultatliste</h2>
            <div id="leaderboardContent"></div>
        </div>
        
        <div id="coursesView" class="content">
            <button class="back-btn" onclick="showView('home')">← Tilbake</button>
            <h2>Scorekort per Bane</h2>
            <div id="coursesContent"></div>
        </div>
        
        <div id="playersView" class="content">
            <button class="back-btn" onclick="showView('home')">← Tilbake</button>
            <h2>Spillere</h2>
            <div id="playersContent"></div>
        </div>
        
        <div id="yearlyResultsView" class="content">
            <button class="back-btn" onclick="showView('home')">← Tilbake</button>
            <h2>Årsresultater</h2>
            <div id="yearlyResultsContent"></div>
        </div>
        
        <div id="historyView" class="content">
            <button class="back-btn" onclick="showView('home')">← Tilbake</button>
            <h2>Spillte Baner Gjennom Årene</h2>
            <div id="historyContent"></div>
        </div>
        
        <div id="whiskyView" class="content">
            <button class="back-btn" onclick="showView('home')">← Tilbake</button>
            <h2>Whisky Samlingen</h2>
            <div id="whiskyContent"></div>
        </div>
        
        <div id="adminView" class="content">
            <button class="back-btn" onclick="showView('home')">← Tilbake</button>
            <h2>Administrator</h2>
            <div id="adminContent"></div>
        </div>
    </div>

    <script>
        // Global variables
        var currentYear = 2025;
        var language = 'no';
        var isAdmin = false;
        var useSlope = true; // Toggle for handicap calculation method
        var scrambleFormula = 'standard'; // 'standard', 'usga', or 'custom'
        
        // Data structure for yearly results
        var yearlyData = JSON.parse(localStorage.getItem('golfYearlyData') || '{}');
        if (!yearlyData[currentYear]) {
            yearlyData[currentYear] = {
                individual: {},
                scramble: {},
                awards: {},
                courses: {},
                schedule: [],
                flightTimes: {}
            };
        }
        
        // Players data - Enhanced with ability to add/remove
        var players = [
            { id: 1, name: 'Klaus', handicap: 18.1 },
            { id: 2, name: 'Ruben', handicap: 11.0 },
            { id: 3, name: 'Sigbjørn', handicap: 20.2 },
            { id: 4, name: 'Bjørn', handicap: 23.8 },
            { id: 5, name: 'Truls', handicap: 36.0 },
            { id: 6, name: 'Tor Espen', handicap: 27.0 },
            { id: 7, name: 'Dag', handicap: 19.4 },
            { id: 8, name: 'Roar', handicap: 25.9 }
        ];
        
        // Historical played courses - Complete list from requirements
        var playedCourses = [
            { id: 1, name: 'Murrayshall GC - Old Course', years: [2010, 2014, 2018] },
            { id: 2, name: 'Murrayshall GC - New Course', years: [2010, 2014, 2018] },
            { id: 3, name: 'Newmacher GC - Hawkshill', years: [2010, 2011, 2012, 2018, 2022] },
            { id: 4, name: 'Newmacher GC - Swailend', years: [2013] },
            { id: 5, name: 'Cruden Bay', years: [2011, 2013, 2015] },
            { id: 6, name: 'Criff GC', years: [2010] },
            { id: 7, name: 'Gleneagle GC - Kings Course', years: [2010] },
            { id: 8, name: 'Royal Aberdeen GC', years: [2012] },
            { id: 9, name: 'Craibstone GC', years: [2011, 2016] },
            { id: 10, name: 'Hazelhead GC - Bane 1', years: [2012] },
            { id: 11, name: 'Hazelhead GC - Bane 2', years: [2012] },
            { id: 12, name: 'Newburgh on Ythan GC', years: [2013] },
            { id: 13, name: 'Meldrum', years: [2015] },
            { id: 14, name: 'Cullen GC', years: [2016] },
            { id: 15, name: 'Duff House Royal GC', years: [2016] },
            { id: 16, name: 'Lundin GC', years: [2017] },
            { id: 17, name: 'Craighead Links', years: [2017] },
            { id: 18, name: 'Balcomie Links', years: [2017] },
            { id: 19, name: 'St. Andrew Eden Course', years: [2017] },
            { id: 20, name: 'St. Andrew GC', years: [2019] },
            { id: 21, name: 'Crail Golf Society', years: [2021] },
            { id: 22, name: 'Stonehaven GC', years: [2021] },
            { id: 23, name: 'Leven GC', years: [2021] },
            { id: 24, name: 'Nairn Golf Club', years: [2022] },
            { id: 25, name: 'Nairn Dunbar Golf Club', years: [2022] },
            { id: 26, name: 'Cullen Links', years: [2023, 2024, 2025] },
            { id: 27, name: 'Spey Bay', years: [2023, 2024, 2025] },
            { id: 28, name: 'Strathlene', years: [2023, 2024, 2025] },
            { id: 29, name: 'Garmouth & Kingston', years: [2023, 2024, 2025] }
        ];
        
        // Whisky collection
        var whiskyCollection = [
            { id: 1, owner: 'Ruben', primary: '', reserve: '' },
            { id: 2, owner: 'Dag', primary: 'Glenmorangie', reserve: '' },
            { id: 3, owner: 'Bjørn', primary: 'Highland Park', reserve: '' },
            { id: 4, owner: 'Sigbjørn', primary: 'MacAllan', reserve: '' },
            { id: 5, owner: 'Truls', primary: 'Dalmore', reserve: 'Old Pultney' },
            { id: 6, owner: 'Roar', primary: 'Glenfiddich', reserve: '' },
            { id: 7, owner: 'Tor Espen', primary: 'Ben Nevis', reserve: '' },
            { id: 8, owner: 'Klaus', primary: 'Balvenie', reserve: '' }
        ];
        
        // Tournament schedule from Excel data
        var schedule = [
            { 
                id: 1, 
                date: 'Fredag 29. aug', 
                time: 'Morgen', 
                course: 'Cullen Links', 
                type: 'Scramble',
                longestDrive: [5, 15],
                closestToPin: [2, 13],
                teams: [
                    ['Klaus', 'Ruben'],
                    ['Sigbjørn', 'Bjørn'],
                    ['Truls', 'Tor Espen'],
                    ['Dag', 'Roar']
                ],
                flights: []
            },
            { 
                id: 2, 
                date: 'Fredag 29. aug', 
                time: 'Ettermiddag', 
                course: 'Cullen Links', 
                type: 'Individuell',
                longestDrive: [5, 15],
                closestToPin: [2, 13],
                flights: [
                    { time: '', players: ['Klaus', 'Ruben', 'Roar', 'Sigbjørn'] },
                    { time: '', players: ['Dag', 'Tor Espen', 'Truls', 'Bjørn'] }
                ]
            },
            { 
                id: 3, 
                date: 'Lørdag 30. aug', 
                time: 'Morgen', 
                course: 'Spey Bay', 
                type: 'Individuell',
                longestDrive: [5, 16],
                closestToPin: [4, 15],
                flights: [
                    { time: '', players: ['Klaus', 'Tor Espen', 'Sigbjørn', 'Bjørn'] },
                    { time: '', players: ['Dag', 'Ruben', 'Truls', 'Roar'] }
                ]
            },
            { 
                id: 4, 
                date: 'Lørdag 30. aug', 
                time: 'Ettermiddag', 
                course: 'Garmouth & Kingston', 
                type: 'Scramble',
                longestDrive: [8],
                closestToPin: [3],
                teams: [
                    ['Truls', 'Roar'],
                    ['Klaus', 'Sigbjørn'],
                    ['Bjørn', 'Dag'],
                    ['Ruben', 'Tor Espen']
                ],
                flights: []
            },
            { 
                id: 5, 
                date: 'Søndag 31. aug', 
                time: 'Hele dagen', 
                course: 'Strathlene', 
                type: 'Individuell',
                longestDrive: [8],
                closestToPin: [7],
                flights: [
                    { time: '', players: ['Klaus', 'Dag', 'Roar', 'Truls'] },
                    { time: '', players: ['Ruben', 'Sigbjørn', 'Tor Espen', 'Bjørn'] }
                ]
            }
        ];
        
        // Course data - Corrected from Excel with proper slope ratings
        var courses = {
            'Cullen Links': { 
                slopeRating: 93,
                courseRating: 67.2,
                par: 63,
                pars: [4,3,3,3,4,3,3,4,3,4,3,3,3,3,5,4,4,4],
                handicaps: [9,7,1,11,3,13,5,17,15,14,6,2,4,8,10,12,18,16],
                yardsWhite: [345,121,233,129,360,181,224,279,195,311,245,179,152,206,511,352,270,330],
                yardsYellow: [335,111,229,109,360,172,204,241,194,300,217,174,127,202,491,347,266,325],
                meters: [306,101,210,99,329,157,187,220,177,275,198,159,116,185,449,317,243,297]
            },
            'Spey Bay': { 
                slopeRating: 114,
                courseRating: 71.8,
                par: 70,
                pars: [4,4,4,3,4,4,4,3,5,4,4,4,3,4,3,5,4,4],
                handicaps: [3,11,7,9,1,17,5,13,15,16,8,4,10,2,14,12,18,6],
                yardsYellow: [417,278,365,107,436,322,338,131,462,336,323,377,165,307,113,452,262,326],
                yardsGold: [423,300,379,112,440,327,385,131,466,340,358,413,194,399,116,521,267,329],
                meters: [381,254,334,98,399,294,309,120,422,307,295,345,151,281,103,413,239,298]
            },
            'Strathlene': { 
                slopeRating: 114,
                courseRating: 69.5,
                par: 70,
                pars: [4,4,4,3,4,4,3,4,4,4,4,4,3,5,4,4,4,3],
                handicaps: [12,16,7,5,9,10,18,3,1,14,8,2,17,11,4,15,6,13],
                yardsWhite: [347,344,369,210,305,350,190,440,425,318,368,385,147,515,396,272,408,188],
                yardsYellow: [335,338,351,207,282,345,181,436,420,312,360,382,142,505,384,269,378,188],
                meters: [306,309,321,189,258,315,165,399,384,285,329,349,130,462,351,246,345,172]
            },
            'Garmouth & Kingston': { 
                slopeRating: 114,
                courseRating: 68.2,
                par: 67,
                pars: [4,4,4,3,4,4,4,4,3,4,4,4,3,4,3,4,4,3],
                handicaps: [7,8,1,9,10,5,14,3,12,6,15,17,18,11,13,2,4,16],
                yardsWhite: [361,390,402,180,365,382,339,327,153,386,264,284,120,303,125,417,418,147],
                yardsYellow: [323,363,394,117,355,351,335,319,136,382,233,263,110,301,125,412,402,125],
                meters: [295,332,360,107,324,321,306,292,124,349,213,240,101,275,114,377,367,114]
            }
        };
        
        // Current year data shortcuts
        var scores = {};
        var scrambleScores = {};
        var awards = {};
        var flightTimes = {};
        
        // Update page title to reflect current year
        function updatePageTitle() {
            document.getElementById('appTitle').textContent = 'Scotland Golf ' + currentYear;
        }
        
        // Load data from localStorage
        function loadFromStorage() {
            var savedYearlyData = localStorage.getItem('golfYearlyData');
            if (savedYearlyData) {
                try {
                    yearlyData = JSON.parse(savedYearlyData);
                    if (!yearlyData[currentYear]) {
                        yearlyData[currentYear] = {
                            individual: {},
                            scramble: {},
                            awards: {},
                            courses: {},
                            schedule: [],
                            flightTimes: {}
                        };
                    }
                } catch (e) {
                    console.log('Error loading yearly data');
                }
            }
            
            scores = yearlyData[currentYear].individual || {};
            scrambleScores = yearlyData[currentYear].scramble || {};
            awards = yearlyData[currentYear].awards || {};
            flightTimes = yearlyData[currentYear].flightTimes || {};
            
            var savedPlayers = localStorage.getItem('golfPlayers');
            if (savedPlayers) {
                try {
                    var parsed = JSON.parse(savedPlayers);
                    if (Array.isArray(parsed) && parsed.length > 0) {
                        players = parsed;
                    }
                } catch (e) {
                    console.log('Error loading players');
                }
            }
            
            // Load admin settings
            useSlope = localStorage.getItem('useSlope') === 'false' ? false : true;
            scrambleFormula = localStorage.getItem('scrambleFormula') || 'standard';
        }
        
        // Save data to localStorage
        function saveToStorage() {
            yearlyData[currentYear].individual = scores;
            yearlyData[currentYear].scramble = scrambleScores;
            yearlyData[currentYear].awards = awards;
            yearlyData[currentYear].courses = courses;
            yearlyData[currentYear].schedule = schedule;
            yearlyData[currentYear].flightTimes = flightTimes;
            
            localStorage.setItem('golfYearlyData', JSON.stringify(yearlyData));
            localStorage.setItem('golfPlayers', JSON.stringify(players));
            localStorage.setItem('useSlope', useSlope.toString());
            localStorage.setItem('scrambleFormula', scrambleFormula);
        }
        
        // Calculate course handicap
        function calculateCourseHandicap(playerHandicap, slopeRating) {
            return Math.round((playerHandicap * slopeRating) / 113);
        }
        
        // Function to calculate scramble team handicap with toggle support
        function calculateScrambleHandicap(teamMembers, courseName) {
            if (useSlope) {
                // Course-based calculation using slope rating
                var course = courses[courseName];
                var courseHandicaps = [];
                
                teamMembers.forEach(function(memberName) {
                    var player = players.find(function(p) { return p.name === memberName; });
                    if (player) {
                        var courseHandicap = calculateCourseHandicap(player.handicap, course.slopeRating);
                        courseHandicaps.push(courseHandicap);
                    }
                });
                
                courseHandicaps.sort(function(a, b) { return a - b; });
                
                if (courseHandicaps.length >= 2) {
                    var lowest = courseHandicaps[0];
                    var highest = courseHandicaps[courseHandicaps.length - 1];
                    return calculateTeamHandicap(lowest, highest);
                }
                return courseHandicaps[0] || 0;
            } else {
                // Direct handicap calculation
                var playerHandicaps = [];
                
                teamMembers.forEach(function(memberName) {
                    var player = players.find(function(p) { return p.name === memberName; });
                    if (player) {
                        playerHandicaps.push(player.handicap);
                    }
                });
                
                playerHandicaps.sort(function(a, b) { return a - b; });
                
                if (playerHandicaps.length >= 2) {
                    var lowest = playerHandicaps[0];
                    var highest = playerHandicaps[playerHandicaps.length - 1];
                    return calculateTeamHandicap(lowest, highest);
                }
                return Math.round(playerHandicaps[0] * 10) / 10 || 0;
            }
        }
        
        // Calculate team handicap based on formula
        function calculateTeamHandicap(lowest, highest) {
            var teamHandicap;
            
            switch(scrambleFormula) {
                case 'standard':
                    teamHandicap = (lowest * 0.35) + (highest * 0.15);
                    break;
                case 'usga':
                    teamHandicap = (lowest * 0.5) + (highest * 0.1);
                    break;
                case 'custom':
                default:
                    teamHandicap = (lowest * 0.7) + (highest * 0.3);
                    break;
            }
            
            return Math.round(teamHandicap * 10) / 10;
        }
        
        // Calculate team strokes for each hole
        function calculateTeamStrokes(teamHandicap, course) {
            var roundedHandicap = Math.round(teamHandicap);
            var strokes = {};
            
            for (var i = 1; i <= 18; i++) {
                var hcpIndex = course.handicaps[i - 1];
                var strokesOnHole = 0;
                
                if (roundedHandicap >= 18) {
                    strokesOnHole = 1;
                    if (hcpIndex <= (roundedHandicap - 18)) strokesOnHole = 2;
                    if (roundedHandicap >= 36 && hcpIndex <= (roundedHandicap - 36)) strokesOnHole = 3;
                } else {
                    if (hcpIndex <= roundedHandicap) strokesOnHole = 1;
                }
                
                strokes[i] = strokesOnHole;
            }
            
            return strokes;
        }
        
        // Toggle scramble stroke display
        function toggleScrambleStrokes(roundId, teamIdx) {
            var checkbox = document.getElementById('strokeToggle');
            var display = document.getElementById('strokeDisplay');
            
            if (checkbox.checked) {
                var round = schedule.find(function(r) { return r.id === roundId; });
                var team = round.teams[teamIdx];
                var course = courses[round.course];
                var teamHandicap = calculateScrambleHandicap(team, round.course);
                var teamStrokes = calculateTeamStrokes(teamHandicap, course);
                
                var html = '<h6>Lag får slag på:</h6>';
                for (var i = 1; i <= 18; i++) {
                    if (teamStrokes[i] > 0) {
                        var strokeText = teamStrokes[i] > 1 ? '+' + teamStrokes[i] : '+1';
                        html += '<span class="hole-stroke">Hull ' + i + ' (SI:' + course.handicaps[i-1] + ') ' + strokeText + '</span>';
                    }
                }
                
                display.innerHTML = html;
                display.style.display = 'block';
            } else {
                display.style.display = 'none';
            }
        }
        
        // Calculate Stableford points
        function calculateStablefordPoints(strokes, par, handicapStrokes) {
            var netStrokes = strokes - handicapStrokes;
            var diff = netStrokes - par;
            
            if (diff <= -2) return 4;
            if (diff === -1) return 3;
            if (diff === 0) return 2;
            if (diff === 1) return 1;
            return 0;
        }
        
        // Calculate pickup ball score
        function calculatePickupScore(par, handicapStrokes) {
            return par + 2 + handicapStrokes;
        }
        
        // Handle pickup ball
        function pickupBall(playerId, roundId, hole) {
            var player = players.find(function(p) { return p.id == playerId; });
            var round = schedule.find(function(r) { return r.id == roundId; });
            var course = courses[round.course];
            var courseHandicap = calculateCourseHandicap(player.handicap, course.slopeRating);
            
            var par = course.pars[hole - 1];
            var hcpIndex = course.handicaps[hole - 1];
            
            var strokesOnHole = 0;
            if (courseHandicap >= 18) {
                strokesOnHole = 1;
                if (hcpIndex <= (courseHandicap - 18)) strokesOnHole = 2;
                if (courseHandicap >= 36 && hcpIndex <= (courseHandicap - 36)) strokesOnHole = 3;
            } else {
                if (hcpIndex <= courseHandicap) strokesOnHole = 1;
            }
            
            var pickupScore = calculatePickupScore(par, strokesOnHole);
            
            var scoreKey = roundId + '_' + playerId;
            if (!scores[scoreKey]) scores[scoreKey] = {};
            scores[scoreKey][hole] = pickupScore;
            
            document.getElementById('hole' + hole).value = pickupScore;
            var holeDiv = document.getElementById('hole' + hole).closest('.hole-input');
            holeDiv.classList.add('pickup-score');
            
            saveToStorage();
            
            var input = document.getElementById('hole' + hole);
            input.style.backgroundColor = '#fed7d7';
            setTimeout(function() {
                input.style.backgroundColor = '';
            }, 1000);
        }
        
        function showView(viewName) {
            document.querySelectorAll('.content').forEach(function(el) {
                el.classList.remove('active');
            });
            
            document.getElementById('homeView').style.display = viewName === 'home' ? 'block' : 'none';
            
            if (viewName !== 'home') {
                document.getElementById(viewName + 'View').classList.add('active');
                
                if (viewName === 'schedule') loadSchedule();
                if (viewName === 'scorecard') loadScorecard();
                if (viewName === 'leaderboard') loadLeaderboard();
                if (viewName === 'courses') loadCourses();
                if (viewName === 'players') loadPlayers();
                if (viewName === 'yearlyResults') loadYearlyResults();
                if (viewName === 'history') loadHistory();
                if (viewName === 'whisky') loadWhisky();
                if (viewName === 'admin') loadAdmin();
            }
        }
        
        function toggleLanguage() {
            language = language === 'no' ? 'en' : 'no';
            document.getElementById('langBtn').textContent = language === 'no' ? '🇬🇧 EN' : '🇳🇴 NO';
            updateLanguage();
        }
        
        function updateLanguage() {
            var texts = {
                no: {
                    appTitle: 'Scotland Golf 2025',
                    appSubtitle: 'Årlig golftur til Skottland',
                    scheduleTitle: 'Timeplan',
                    scheduleDesc: 'Se runder',
                    scorecardTitle: 'Registrer',
                    scorecardDesc: 'Legg inn score',
                    leaderboardTitle: 'Resultater',
                    leaderboardDesc: 'Live stilling',
                    coursesTitle: 'Baner',
                    coursesDesc: 'Scorekort',
                    playersTitle: 'Spillere',
                    playersDesc: 'Handicap',
                    yearlyTitle: 'Årsresultater',
                    yearlyDesc: 'Alle år',
                    historyTitle: 'Historie',
                    historyDesc: 'Spillte baner',
                    whiskyTitle: 'Whisky',
                    whiskyDesc: 'Samlingen',
                    adminTitle: 'Admin',
                    adminDesc: 'Administrer'
                },
                en: {
                    appTitle: 'Scotland Golf 2025',
                    appSubtitle: 'Annual Golf Trip to Scotland',
                    scheduleTitle: 'Schedule',
                    scheduleDesc: 'View rounds',
                    scorecardTitle: 'Enter',
                    scorecardDesc: 'Add scores',
                    leaderboardTitle: 'Results',
                    leaderboardDesc: 'Live scores',
                    coursesTitle: 'Courses',
                    coursesDesc: 'Scorecards',
                    playersTitle: 'Players',
                    playersDesc: 'Handicaps',
                    yearlyTitle: 'Year Results',
                    yearlyDesc: 'All years',
                    historyTitle: 'History',
                    historyDesc: 'Played courses',
                    whiskyTitle: 'Whisky',
                    whiskyDesc: 'Collection',
                    adminTitle: 'Admin',
                    adminDesc: 'Manage'
                }
            };
            
            var t = texts[language];
            Object.keys(t).forEach(function(key) {
                var el = document.getElementById(key);
                if (el) el.textContent = t[key];
            });
        }
        
        function loadSchedule() {
            var html = '';
            schedule.forEach(function(round) {
                html += '<div class="schedule-item">';
                html += '<strong>' + round.date + ' - ' + round.time + '</strong><br>';
                html += round.course + '<br>';
                html += '<span style="color: #4299e1;">' + round.type + '</span>';
                
                if (round.type === 'Individuell' && round.flights && round.flights.length > 0) {
                    html += '<div class="flight-section"><strong>Flights:</strong>';
                    round.flights.forEach(function(flight, j) {
                        var flightTime = flightTimes[round.id + '_flight_' + j] || flight.time || '';
                        html += '<div class="flight-item">';
                        html += '<strong>Flight ' + (j + 1) + ':</strong> ' + flight.players.join(', ');
                        if (flightTime) {
                            html += ' <span style="color: #4299e1;">(' + flightTime + ')</span>';
                        }
                        html += '</div>';
                    });
                    html += '</div>';
                }
                
                if (round.teams) {
                    html += '<div class="team-section"><strong>Lag:</strong><br>';
                    round.teams.forEach(function(team, j) {
                        var teamTime = flightTimes[round.id + '_team_' + j] || '';
                        var teamHandicap = calculateScrambleHandicap(team, round.course);
                        var allocatedStrokes = Math.round(teamHandicap);
                        html += '<div>Lag ' + (j + 1) + ': ' + team.join(' & ');
                        html += ' <span style="color: #16a085; font-weight: bold;">(Tildelte slag: ' + allocatedStrokes + ')</span>';
                        if (teamTime) {
                            html += ' <span style="color: #4299e1;">(' + teamTime + ')</span>';
                        }
                        html += '</div>';
                    });
                    html += '</div>';
                }
                
                if (round.longestDrive) {
                    html += '<div>🚀 Lengste drive: Hull ' + round.longestDrive.join(', ') + '</div>';
                }
                if (round.closestToPin) {
                    html += '<div>🎯 Nærmest pinnen: Hull ' + round.closestToPin.join(', ') + '</div>';
                }
                
                html += '</div>';
            });
            document.getElementById('scheduleContent').innerHTML = html;
        }
        
        function loadScorecard() {
            var html = '<h3>Velg runde:</h3>';
            schedule.forEach(function(round) {
                html += '<div class="round-select" onclick="selectRound(' + round.id + ')">';
                html += '<strong>' + round.date + ' - ' + round.time + '</strong><br>';
                html += round.course + ' (' + round.type + ')';
                html += '</div>';
            });
            html += '<div id="scorecardForm"></div>';
            document.getElementById('scorecardContent').innerHTML = html;
        }
        
        function selectRound(roundId) {
            var round = schedule.find(function(r) { return r.id === roundId; });
            var html = '<h3>' + round.course + ' - ' + round.date + '</h3>';
            
            if (round.type === 'Scramble') {
                html += '<h4>Velg lag:</h4>';
                round.teams.forEach(function(team, idx) {
                    var teamHandicap = calculateScrambleHandicap(team, round.course);
                    var allocatedStrokes = Math.round(teamHandicap);
                    html += '<div class="team-select" onclick="selectTeam(' + roundId + ', ' + idx + ')">';
                    html += '<strong>Lag ' + (idx + 1) + '</strong><br>';
                    html += team.join(' & ');
                    html += '<br><span style="color: #718096; font-size: 12px;">Tildelte slag: ' + allocatedStrokes + '</span>';
                    html += '</div>';
                });
            } else {
                html += '<h4>Velg spiller:</h4>';
                html += '<select id="playerSelect" onchange="loadScorecardForm()">';
                html += '<option value="">-- Velg spiller --</option>';
                players.forEach(function(player) {
                    html += '<option value="' + player.id + '">' + player.name + '</option>';
                });
                html += '</select>';
                html += '<input type="hidden" id="selectedRound" value="' + roundId + '">';
                html += '<div id="holesForm"></div>';
            }
            
            document.getElementById('scorecardForm').innerHTML = html;
        }
        
        function selectTeam(roundId, teamIdx) {
            var round = schedule.find(function(r) { return r.id === roundId; });
            var team = round.teams[teamIdx];
            var course = courses[round.course];
            var scoreKey = roundId + '_team_' + teamIdx;
            var existingScores = scrambleScores[scoreKey] || {};
            var teamHandicap = calculateScrambleHandicap(team, round.course);
            var allocatedStrokes = Math.round(teamHandicap);
            
            // Calculate team strokes per hole
            var teamStrokesPerHole = calculateTeamStrokes(teamHandicap, course);
            var totalTeamStrokes = 0;
            Object.values(teamStrokesPerHole).forEach(function(strokes) {
                totalTeamStrokes += strokes;
            });
            
            var html = '<h3>' + round.course + ' - ' + round.date + '</h3>';
            html += '<h4>Lag ' + (teamIdx + 1) + ': ' + team.join(' & ') + '</h4>';
            
            // Show scramble handicap info with calculation method
            html += '<div class="scramble-handicap-info">';
            html += '<h5>Scramble Handicap Beregning</h5>';
            
            var playerHandicaps = [];
            team.forEach(function(memberName) {
                var player = players.find(function(p) { return p.name === memberName; });
                if (player) {
                    playerHandicaps.push({name: memberName, handicap: player.handicap});
                    html += '<p>' + memberName + ': HCP ' + player.handicap + '</p>';
                }
            });
            
            // Sort to show calculation
            playerHandicaps.sort(function(a, b) { return a.handicap - b.handicap; });
            
            if (playerHandicaps.length >= 2) {
                var lowest = playerHandicaps[0].handicap;
                var highest = playerHandicaps[playerHandicaps.length - 1].handicap;
                
                if (useSlope) {
                    var lowestCourse = calculateCourseHandicap(lowest, course.slopeRating);
                    var highestCourse = calculateCourseHandicap(highest, course.slopeRating);
                    html += '<p style="margin-top: 10px; color: #4299e1;">Banehandicap (slope ' + course.slopeRating + '):</p>';
                    html += '<p style="color: #4299e1;">' + playerHandicaps[0].name + ': ' + lowestCourse + ', ' + playerHandicaps[playerHandicaps.length-1].name + ': ' + highestCourse + '</p>';
                } else {
                    html += '<p style="margin-top: 10px; color: #4299e1;">Direkte handicap beregning:</p>';
                }
                
                var formulaText = scrambleFormula === 'standard' ? '35% lavest + 15% høyest' :
                                  scrambleFormula === 'usga' ? '50% lavest + 10% høyest' :
                                  '70% lavest + 30% høyest';
                html += '<p style="color: #4299e1;">Formel: ' + formulaText + '</p>';
            }
            
            html += '<p><strong>Tildelte slag: ' + allocatedStrokes + '</strong></p>';
            html += '<p style="color: #718096; font-size: 12px;">Netto score = Brutto - ' + allocatedStrokes + '</p>';
            
            // Show team stroke distribution
            html += '<div style="margin-top: 10px; padding: 10px; background: #f0f9ff; border-radius: 5px; font-size: 12px;">';
            html += '<strong>Lag får ekstra slag på:</strong><br>';
            var strokeHoles1 = [];
            var strokeHoles2 = [];
            var strokeHoles3 = [];
            
            for (var i = 1; i <= 18; i++) {
                if (teamStrokesPerHole[i] === 1) strokeHoles1.push(i);
                if (teamStrokesPerHole[i] === 2) strokeHoles2.push(i);
                if (teamStrokesPerHole[i] === 3) strokeHoles3.push(i);
            }
            
            if (strokeHoles1.length > 0) {
                html += '+1 slag på hull: ' + strokeHoles1.join(', ') + '<br>';
            }
            if (strokeHoles2.length > 0) {
                html += '+2 slag på hull: ' + strokeHoles2.join(', ') + '<br>';
            }
            if (strokeHoles3.length > 0) {
                html += '+3 slag på hull: ' + strokeHoles3.join(', ') + '<br>';
            }
            html += '</div>';
            
            // Add stroke toggle
            html += '<div class="stroke-toggle">';
            html += '<label><input type="checkbox" id="strokeToggle" onchange="toggleScrambleStrokes(' + roundId + ', ' + teamIdx + ')"> Vis slag per hull på scorekort</label>';
            html += '</div>';
            html += '<div id="strokeDisplay" class="stroke-display" style="display: none;"></div>';
            
            html += '</div>';
            
            html += '<h4>Registrer lagscore:</h4>';
            
            html += '<div class="nine-section">';
            html += '<h5>Front 9</h5>';
            html += '<div class="scorecard-grid">';
            for (var i = 1; i <= 9; i++) {
                var par = course.pars[i-1];
                var hcpIndex = course.handicaps[i-1];
                var value = existingScores[i] || '';
                var strokesOnHole = teamStrokesPerHole[i];
                var hasStroke = strokesOnHole > 0;
                var strokeText = strokesOnHole > 0 ? ' (+' + strokesOnHole + ')' : '';
                
                html += '<div class="hole-input ' + (hasStroke ? 'stroke' : '') + '">';
                html += '<label>Hull ' + i + ' (Par ' + par + strokeText + ')</label>';
                html += '<div style="font-size: 11px; color: #718096; margin-bottom: 3px;">SI: ' + hcpIndex;
                if (strokesOnHole > 0) {
                    html += ' <span style="color: #f59e0b; font-weight: bold;">+' + strokesOnHole + ' slag</span>';
                }
                html += '</div>';
                html += '<input type="number" id="hole' + i + '" min="1" max="15" value="' + value + '" ';
                html += 'onchange="autoSaveTeamScore(' + roundId + ', ' + teamIdx + ', ' + i + ')">';
                html += '</div>';
            }
            html += '</div></div>';
            
            html += '<div class="nine-section">';
            html += '<h5>Back 9</h5>';
            html += '<div class="scorecard-grid">';
            for (var i = 10; i <= 18; i++) {
                var par = course.pars[i-1];
                var hcpIndex = course.handicaps[i-1];
                var value = existingScores[i] || '';
                var strokesOnHole = teamStrokesPerHole[i];
                var hasStroke = strokesOnHole > 0;
                var strokeText = strokesOnHole > 0 ? ' (+' + strokesOnHole + ')' : '';
                
                html += '<div class="hole-input ' + (hasStroke ? 'stroke' : '') + '">';
                html += '<label>Hull ' + i + ' (Par ' + par + strokeText + ')</label>';
                html += '<div style="font-size: 11px; color: #718096; margin-bottom: 3px;">SI: ' + hcpIndex;
                if (strokesOnHole > 0) {
                    html += ' <span style="color: #f59e0b; font-weight: bold;">+' + strokesOnHole + ' slag</span>';
                }
                html += '</div>';
                html += '<input type="number" id="hole' + i + '" min="1" max="15" value="' + value + '" ';
                html += 'onchange="autoSaveTeamScore(' + roundId + ', ' + teamIdx + ', ' + i + ')">';
                html += '</div>';
            }
            html += '</div></div>';
            
            document.getElementById('scorecardForm').innerHTML = html;
        }
        
        function loadScorecardForm() {
            var playerId = document.getElementById('playerSelect').value;
            var roundId = document.getElementById('selectedRound').value;
            
            if (!playerId) return;
            
            var player = players.find(function(p) { return p.id == playerId; });
            var round = schedule.find(function(r) { return r.id == roundId; });
            var course = courses[round.course];
            var courseHandicap = calculateCourseHandicap(player.handicap, course.slopeRating);
            var scoreKey = roundId + '_' + playerId;
            var existingScores = scores[scoreKey] || {};
            
            // Calculate total strokes received
            var totalStrokesReceived = 0;
            var strokesPerHole = {};
            
            for (var i = 1; i <= 18; i++) {
                var hcpIndex = course.handicaps[i-1];
                var strokesOnHole = 0;
                
                if (courseHandicap >= 18) {
                    strokesOnHole = 1;
                    if (hcpIndex <= (courseHandicap - 18)) strokesOnHole = 2;
                    if (courseHandicap >= 36 && hcpIndex <= (courseHandicap - 36)) strokesOnHole = 3;
                } else {
                    if (hcpIndex <= courseHandicap) strokesOnHole = 1;
                }
                
                strokesPerHole[i] = strokesOnHole;
                totalStrokesReceived += strokesOnHole;
            }
            
            var html = '<div class="handicap-info">';
            html += '<strong>' + player.name + '</strong><br>';
            html += 'Handicap: ' + player.handicap + ' | Banehandicap: ' + courseHandicap + '<br>';
            html += '<strong>Totalt ekstra slag: ' + totalStrokesReceived + '</strong><br>';
            html += 'Skåringssystem: <strong>Stableford</strong><br>';
            html += 'Beregningsmetode: ' + (useSlope ? 'Slope-justert' : 'Direkte handicap');
            
            // Show stroke distribution
            html += '<div style="margin-top: 10px; padding: 10px; background: #f0f9ff; border-radius: 5px; font-size: 12px;">';
            html += '<strong>Slag fordeling:</strong><br>';
            var strokeHoles1 = [];
            var strokeHoles2 = [];
            var strokeHoles3 = [];
            
            for (var i = 1; i <= 18; i++) {
                if (strokesPerHole[i] === 1) strokeHoles1.push(i);
                if (strokesPerHole[i] === 2) strokeHoles2.push(i);
                if (strokesPerHole[i] === 3) strokeHoles3.push(i);
            }
            
            if (strokeHoles1.length > 0) {
                html += '+1 slag på hull: ' + strokeHoles1.join(', ') + '<br>';
            }
            if (strokeHoles2.length > 0) {
                html += '+2 slag på hull: ' + strokeHoles2.join(', ') + '<br>';
            }
            if (strokeHoles3.length > 0) {
                html += '+3 slag på hull: ' + strokeHoles3.join(', ') + '<br>';
            }
            html += '</div>';
            
            html += '</div>';
            
            html += '<div class="nine-section">';
            html += '<h5>Front 9</h5>';
            html += '<div class="scorecard-grid">';
            for (var i = 1; i <= 9; i++) {
                var par = course.pars[i-1];
                var hcpIndex = course.handicaps[i-1];
                var value = existingScores[i] || '';
                
                var strokesOnHole = strokesPerHole[i];
                var hasStroke = strokesOnHole > 0;
                var strokeText = strokesOnHole > 0 ? ' (+' + strokesOnHole + ')' : '';
                var pickupScore = calculatePickupScore(par, strokesOnHole);
                var isPickup = (value == pickupScore);
                
                html += '<div class="hole-input ' + (hasStroke ? 'stroke' : '') + (isPickup ? ' pickup-score' : '') + '">';
                html += '<label>Hull ' + i + ' (Par ' + par + strokeText + ')</label>';
                html += '<div style="font-size: 11px; color: #718096; margin-bottom: 3px;">SI: ' + hcpIndex;
                if (strokesOnHole > 0) {
                    html += ' <span style="color: #f59e0b; font-weight: bold;">+' + strokesOnHole + ' slag</span>';
                }
                html += '</div>';
                html += '<input type="number" id="hole' + i + '" min="1" max="15" value="' + value + '" ';
                html += 'onchange="autoSaveScore(' + playerId + ', ' + roundId + ', ' + i + ')">';
                html += '<button class="pickup-btn" onclick="pickupBall(' + playerId + ', ' + roundId + ', ' + i + ')">Pickup (' + pickupScore + ')</button>';
                html += '</div>';
            }
            html += '</div></div>';
            
            html += '<div class="nine-section">';
            html += '<h5>Back 9</h5>';
            html += '<div class="scorecard-grid">';
            for (var i = 10; i <= 18; i++) {
                var par = course.pars[i-1];
                var hcpIndex = course.handicaps[i-1];
                var value = existingScores[i] || '';
                
                var strokesOnHole = strokesPerHole[i];
                var hasStroke = strokesOnHole > 0;
                var strokeText = strokesOnHole > 0 ? ' (+' + strokesOnHole + ')' : '';
                var pickupScore = calculatePickupScore(par, strokesOnHole);
                var isPickup = (value == pickupScore);
                
                html += '<div class="hole-input ' + (hasStroke ? 'stroke' : '') + (isPickup ? ' pickup-score' : '') + '">';
                html += '<label>Hull ' + i + ' (Par ' + par + strokeText + ')</label>';
                html += '<div style="font-size: 11px; color: #718096; margin-bottom: 3px;">SI: ' + hcpIndex;
                if (strokesOnHole > 0) {
                    html += ' <span style="color: #f59e0b; font-weight: bold;">+' + strokesOnHole + ' slag</span>';
                }
                html += '</div>';
                html += '<input type="number" id="hole' + i + '" min="1" max="15" value="' + value + '" ';
                html += 'onchange="autoSaveScore(' + playerId + ', ' + roundId + ', ' + i + ')">';
                html += '<button class="pickup-btn" onclick="pickupBall(' + playerId + ', ' + roundId + ', ' + i + ')">Pickup (' + pickupScore + ')</button>';
                html += '</div>';
            }
            html += '</div></div>';
            
            document.getElementById('holesForm').innerHTML = html;
        }
        
        function autoSaveScore(playerId, roundId, hole) {
            var scoreKey = roundId + '_' + playerId;
            var value = document.getElementById('hole' + hole).value;
            
            if (!scores[scoreKey]) scores[scoreKey] = {};
            
            if (value === '') {
                delete scores[scoreKey][hole];
                var holeDiv = document.getElementById('hole' + hole).closest('.hole-input');
                holeDiv.classList.remove('pickup-score');
            } else {
                scores[scoreKey][hole] = parseInt(value);
            }
            
            saveToStorage();
            
            var input = document.getElementById('hole' + hole);
            input.style.backgroundColor = '#c6f6d5';
            setTimeout(function() {
                input.style.backgroundColor = '';
            }, 500);
        }
        
        function autoSaveTeamScore(roundId, teamIdx, hole) {
            var scoreKey = roundId + '_team_' + teamIdx;
            var value = document.getElementById('hole' + hole).value;
            
            if (!scrambleScores[scoreKey]) scrambleScores[scoreKey] = {};
            
            if (value === '') {
                delete scrambleScores[scoreKey][hole];
            } else {
                scrambleScores[scoreKey][hole] = parseInt(value);
            }
            
            saveToStorage();
            
            var input = document.getElementById('hole' + hole);
            input.style.backgroundColor = '#c6f6d5';
            setTimeout(function() {
                input.style.backgroundColor = '';
            }, 500);
        }
        
        function loadLeaderboard() {
            var html = '<div class="overall-section">';
            html += '<h3>⭐ SAMMENLAGT STILLING ' + currentYear + ' ⭐</h3>';
            html += '<div class="overall-table"><div class="table-wrapper">';
            html += '<table><thead><tr><th>Spiller</th><th>Poeng</th><th>Runder</th></tr></thead><tbody>';
            
            var overallScores = {};
            players.forEach(function(player) {
                overallScores[player.name] = { points: 0, rounds: 0 };
            });
            
            // Calculate individual scores
            schedule.forEach(function(round) {
                if (round.type === 'Individuell') {
                    players.forEach(function(player) {
                        var scoreKey = round.id + '_' + player.id;
                        var roundScores = scores[scoreKey];
                        
                        if (roundScores && Object.keys(roundScores).length > 0) {
                            var course = courses[round.course];
                            var courseHandicap = calculateCourseHandicap(player.handicap, course.slopeRating);
                            
                            var totalPoints = 0;
                            Object.keys(roundScores).forEach(function(hole) {
                                var holeNum = parseInt(hole);
                                var strokes = roundScores[hole];
                                var par = course.pars[holeNum - 1];
                                var hcpIndex = course.handicaps[holeNum - 1];
                                
                                var strokesOnHole = 0;
                                if (courseHandicap >= 18) {
                                    strokesOnHole = 1;
                                    if (hcpIndex <= (courseHandicap - 18)) strokesOnHole = 2;
                                    if (courseHandicap >= 36 && hcpIndex <= (courseHandicap - 36)) strokesOnHole = 3;
                                } else {
                                    if (hcpIndex <= courseHandicap) strokesOnHole = 1;
                                }
                                
                                totalPoints += calculateStablefordPoints(strokes, par, strokesOnHole);
                            });
                            
                            overallScores[player.name].points += totalPoints;
                            overallScores[player.name].rounds++;
                        }
                    });
                }
            });
            
            var sortedOverall = [];
            Object.keys(overallScores).forEach(function(name) {
                sortedOverall.push({
                    name: name,
                    points: overallScores[name].points,
                    rounds: overallScores[name].rounds
                });
            });
            
            sortedOverall.sort(function(a, b) { return b.points - a.points; });
            
            sortedOverall.forEach(function(player, idx) {
                html += '<tr>';
                html += '<td>' + (idx === 0 ? '<span class="trophy">🏆</span>' : '') + player.name + '</td>';
                html += '<td><strong>' + player.points + '</strong></td>';
                html += '<td>' + player.rounds + '</td>';
                html += '</tr>';
            });
            
            html += '</tbody></table></div></div></div>';
            
            // Add scramble results
            html += '<div style="margin-top: 30px;">';
            html += '<h3>Scramble Resultater</h3>';
            
            schedule.forEach(function(round) {
                if (round.type === 'Scramble') {
                    html += '<div class="course-section">';
                    html += '<h4>' + round.date + ' - ' + round.course + '</h4>';
                    
                    var scrambleResults = [];
                    round.teams.forEach(function(team, idx) {
                        var scoreKey = round.id + '_team_' + idx;
                        var teamScores = scrambleScores[scoreKey];
                        
                        if (teamScores) {
                            var totalStrokes = 0;
                            var holesPlayed = 0;
                            Object.keys(teamScores).forEach(function(hole) {
                                totalStrokes += teamScores[hole];
                                holesPlayed++;
                            });
                            
                            if (holesPlayed > 0) {
                                var teamHandicap = calculateScrambleHandicap(team, round.course);
                                var allocatedStrokes = Math.round(teamHandicap);
                                var netScore = totalStrokes - allocatedStrokes;
                                
                                scrambleResults.push({
                                    team: team,
                                    teamName: team.join(' & '),
                                    gross: totalStrokes,
                                    handicap: allocatedStrokes,
                                    net: netScore,
                                    holesPlayed: holesPlayed
                                });
                            }
                        }
                    });
                    
                    scrambleResults.sort(function(a, b) { return a.net - b.net; });
                    
                    scrambleResults.forEach(function(result, idx) {
                        var isWinner = idx === 0;
                        html += '<div class="scramble-result' + (isWinner ? ' winner' : '') + '">';
                        html += '<strong>' + (idx + 1) + '. ' + result.teamName + '</strong>';
                        if (isWinner) html += ' 🏆';
                        html += '<br>Brutto: ' + result.gross + ' | Handicap: ' + result.handicap + ' | <strong>Netto: ' + result.net + '</strong>';
                        if (result.holesPlayed < 18) {
                            html += ' (' + result.holesPlayed + ' hull)';
                        }
                        html += '</div>';
                    });
                    
                    html += '</div>';
                }
            });
            
            html += '</div>';
            
            document.getElementById('leaderboardContent').innerHTML = html;
        }
        
        function loadCourses() {
            var html = '<p>Detaljerte scorekort for hver bane:</p>';
            
            Object.keys(courses).forEach(function(courseName) {
                var course = courses[courseName];
                html += '<div class="course-section">';
                html += '<h3>' + courseName + '</h3>';
                html += '<p>Par: ' + course.par + ' | Slope: ' + course.slopeRating + '</p>';
                
                html += '<div class="table-wrapper">';
                html += '<table>';
                html += '<thead><tr>';
                html += '<th>Hull</th>';
                for (var i = 1; i <= 18; i++) {
                    html += '<th>' + i + '</th>';
                }
                html += '</tr></thead>';
                html += '<tbody>';
                
                // Par row
                html += '<tr><td><strong>Par</strong></td>';
                course.pars.forEach(function(par) {
                    html += '<td>' + par + '</td>';
                });
                html += '</tr>';
                
                // Handicap row
                html += '<tr><td><strong>SI</strong></td>';
                course.handicaps.forEach(function(hcp) {
                    html += '<td>' + hcp + '</td>';
                });
                html += '</tr>';
                
                // Show yards if available
                if (course.yardsYellow) {
                    html += '<tr><td><strong>Yards</strong></td>';
                    course.yardsYellow.forEach(function(yards) {
                        html += '<td>' + yards + '</td>';
                    });
                    html += '</tr>';
                }
                
                html += '</tbody></table></div>';
                html += '</div>';
            });
            
            document.getElementById('coursesContent').innerHTML = html;
        }
        
        function loadPlayers() {
            var html = '<div style="margin-bottom: 20px;">';
            html += '<h3>Spillere og Handicap</h3>';
            html += '<p style="color: #718096;">Beregningsmetode: ' + (useSlope ? 'Slope-justert' : 'Direkte handicap') + '</p>';
            html += '</div>';
            
            html += '<div class="player-grid">';
            players.forEach(function(player) {
                html += '<div class="player-card">';
                html += '<h4>' + player.name + '</h4>';
                html += '<p><strong>Handicap: ' + player.handicap + '</strong></p>';
                html += '<p style="font-size: 12px; margin-top: 10px; color: #4299e1;"><strong>Banehandicap:</strong></p>';
                
                Object.keys(courses).forEach(function(courseName) {
                    var course = courses[courseName];
                    var courseHandicap = calculateCourseHandicap(player.handicap, course.slopeRating);
                    html += '<p style="font-size: 11px;">' + courseName + ': ' + courseHandicap + '</p>';
                });
                
                // Add scramble handicap info
                html += '<p style="font-size: 12px; margin-top: 10px; color: #16a085;"><strong>Scramble Handicap Info:</strong></p>';
                
                // Show scramble calculations for each team this player is in
                schedule.forEach(function(round) {
                    if (round.type === 'Scramble' && round.teams) {
                        round.teams.forEach(function(team, teamIdx) {
                            if (team.includes(player.name)) {
                                var teamHandicap = calculateScrambleHandicap(team, round.course);
                                html += '<p style="font-size: 10px;">' + round.course + ' (Lag ' + (teamIdx + 1) + '): ' + teamHandicap + '</p>';
                            }
                        });
                    }
                });
                
                html += '</div>';
            });
            html += '</div>';
            
            document.getElementById('playersContent').innerHTML = html;
        }
        
        function loadYearlyResults() {
            var html = '<h3>Turnering Resultater Gjennom Årene</h3>';
            
            var availableYears = Object.keys(yearlyData).sort().reverse();
            
            if (availableYears.length > 0) {
                availableYears.forEach(function(year) {
                    var yearData = yearlyData[year];
                    var isCurrentYear = parseInt(year) === currentYear;
                    
                    html += '<div class="year-results">';
                    html += '<h4>Turnering ' + year + (isCurrentYear ? ' (Pågående)' : '') + '</h4>';
                    
                    if (yearData.archived && !isCurrentYear) {
                        // Show archived results
                        html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">';
                        
                        // Overall Winner
                        if (yearData.archived.overallWinner) {
                            html += '<div style="background: #c6f6d5; padding: 15px; border-radius: 10px; border: 2px solid #48bb78;">';
                            html += '<h5>🏆 Sammenlagt Vinner</h5>';
                            html += '<p><strong>' + yearData.archived.overallWinner.name + '</strong></p>';
                            html += '<p>' + yearData.archived.overallWinner.points + ' poeng (' + yearData.archived.overallWinner.rounds + ' runder)</p>';
                            html += '</div>';
                        }
                        
                        // Final Standings
                        if (yearData.archived.finalStandings && yearData.archived.finalStandings.length > 0) {
                            html += '<div style="background: #f0f9ff; padding: 15px; border-radius: 10px;">';
                            html += '<h5>📊 Sluttresultat</h5>';
                            html += '<div class="table-wrapper">';
                            html += '<table style="font-size: 11px;"><thead><tr><th>Pos</th><th>Spiller</th><th>Poeng</th></tr></thead><tbody>';
                            
                            yearData.archived.finalStandings.forEach(function(player, idx) {
                                html += '<tr>';
                                html += '<td>' + (idx + 1) + (idx === 0 ? ' 🥇' : idx === 1 ? ' 🥈' : idx === 2 ? ' 🥉' : '') + '</td>';
                                html += '<td>' + player.name + '</td>';
                                html += '<td>' + player.points + '</td>';
                                html += '</tr>';
                            });
                            
                            html += '</tbody></table></div>';
                            html += '</div>';
                        }
                        
                        html += '</div>';
                        
                        // Scramble Winners
                        if (yearData.archived.scrambleWinners && yearData.archived.scrambleWinners.length > 0) {
                            html += '<div style="margin-top: 15px;">';
                            html += '<h5>🏌 Scramble Vinnere</h5>';
                            html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 10px;">';
                            
                            yearData.archived.scrambleWinners.forEach(function(scrambleRound) {
                                html += '<div style="background: #e6fffa; padding: 10px; border-radius: 8px; border: 2px solid #38b2ac;">';
                                html += '<h6>' + scrambleRound.course + '</h6>';
                                html += '<p style="font-size: 12px; color: #718096;">' + scrambleRound.date + '</p>';
                                html += '<p><strong>' + scrambleRound.winner.team + '</strong></p>';
                                html += '<p style="font-size: 12px;">Netto: ' + scrambleRound.winner.net + ' (Brutto: ' + scrambleRound.winner.gross + ', Slag: ' + scrambleRound.winner.handicap + ')</p>';
                                html += '</div>';
                            });
                            
                            html += '</div>';
                            html += '</div>';
                        }
                        
                        // Competition Winners
                        if (yearData.archived.competitionWinners && Object.keys(yearData.archived.competitionWinners).length > 0) {
                            html += '<div style="margin-top: 15px;">';
                            html += '<h5>🎯 Konkurranser</h5>';
                            html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px; font-size: 12px;">';
                            
                            Object.keys(yearData.archived.competitionWinners).forEach(function(key) {
                                var winner = yearData.archived.competitionWinners[key];
                                if (winner) {
                                    var parts = key.split('_');
                                    var competitionType = parts[1] === 'ld' ? 'Lengste Drive' : 'Nærmest Pinnen';
                                    var hole = parts[2];
                                    
                                    html += '<div style="background: #fef3c7; padding: 8px; border-radius: 6px;">';
                                    html += '<strong>' + competitionType + '</strong><br>';
                                    html += 'Hull ' + hole + ': ' + winner;
                                    html += '</div>';
                                }
                            });
                            
                            html += '</div>';
                            html += '</div>';
                        }
                        
                        // Tournament Stats
                        if (yearData.archived.tournamentStats) {
                            var stats = yearData.archived.tournamentStats;
                            html += '<div style="margin-top: 15px; padding: 10px; background: #f7fafc; border-radius: 8px; font-size: 12px;">';
                            html += '<strong>Turnering Statistikk:</strong> ';
                            html += stats.totalPlayers + ' spillere, ' + stats.totalRounds + ' runder, ';
                            html += (stats.coursesPlayed ? stats.coursesPlayed.length : 0) + ' baner spilt';
                            html += '</div>';
                        }
                        
                    } else if (isCurrentYear) {
                        // Show current year status
                        var currentScores = Object.keys(scores).length;
                        var currentScrambleScores = Object.keys(scrambleScores).length;
                        var currentAwards = Object.keys(awards).length;
                        
                        html += '<div style="background: #fef5e7; padding: 15px; border-radius: 10px;">';
                        html += '<p>🔄 <strong>Pågående turnering</strong></p>';
                        html += '<div style="margin-top: 10px; font-size: 13px;">';
                        html += '<p>Registrerte individuelle scorekort: ' + currentScores + '</p>';
                        html += '<p>Registrerte scramble scorekort: ' + currentScrambleScores + '</p>';
                        html += '<p>Tildelte konkurransepriser: ' + currentAwards + '</p>';
                        html += '</div>';
                        html += '<p style="font-size: 12px; color: #718096; margin-top: 10px;">Resultater vil bli arkivert når nytt år opprettes</p>';
                        html += '</div>';
                        
                    } else {
                        // Year exists but no archived data
                        html += '<div style="background: #f3f4f6; padding: 15px; border-radius: 10px;">';
                        html += '<p>Ingen arkiverte resultater tilgjengelig for dette året.</p>';
                        html += '</div>';
                    }
                    
                    html += '</div>';
                });
            } else {
                html += '<p>Ingen turnering data tilgjengelig.</p>';
            }
            
            document.getElementById('yearlyResultsContent').innerHTML = html;
        }
        
        function loadHistory() {
            var allYears = [];
            playedCourses.forEach(function(course) {
                course.years.forEach(function(year) {
                    if (allYears.indexOf(year) === -1) {
                        allYears.push(year);
                    }
                });
            });
            allYears.sort(function(a, b) { return b - a; });
            
            var html = '<div style="margin-bottom: 20px;">';
            html += '<h3>Skottland Golfturer - Spillte Baner</h3>';
            html += '<p style="color: #718096;">Totalt ' + playedCourses.length + ' forskjellige baner siden 2010</p>';
            html += '</div>';
            
            var coursesByYear = {};
            allYears.forEach(function(year) {
                coursesByYear[year] = [];
            });
            
            playedCourses.forEach(function(course) {
                course.years.forEach(function(year) {
                    coursesByYear[year].push(course.name);
                });
            });
            
            html += '<div style="margin-bottom: 30px;">';
            allYears.forEach(function(year) {
                if (coursesByYear[year] && coursesByYear[year].length > 0) {
                    html += '<div class="course-section" style="margin-bottom: 20px;">';
                    html += '<h4 style="color: #2d3748; margin-bottom: 10px;">' + year;
                    if (year === 2019) html += ' (Jubileumstur!)';
                    html += ' (' + coursesByYear[year].length + ' baner)</h4>';
                    html += '<div style="background: #f7fafc; padding: 15px; border-radius: 10px;">';
                    coursesByYear[year].forEach(function(courseName) {
                        html += '<div style="padding: 5px 0;">• ' + courseName + '</div>';
                    });
                    html += '</div>';
                    html += '</div>';
                }
            });
            html += '</div>';
            
            html += '<h3 style="margin-top: 40px; margin-bottom: 20px;">Alle Baner (Alfabetisk)</h3>';
            html += '<div class="table-wrapper">';
            html += '<table><thead><tr><th>Bane</th><th>År Spilt</th><th>Antall Ganger</th></tr></thead><tbody>';
            
            var sortedCourses = playedCourses.slice().sort(function(a, b) {
                return a.name.localeCompare(b.name);
            });
            
            sortedCourses.forEach(function(course) {
                html += '<tr>';
                html += '<td>' + course.name + '</td>';
                html += '<td>' + course.years.join(', ') + '</td>';
                html += '<td>' + course.years.length + '</td>';
                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
            
            document.getElementById('historyContent').innerHTML = html;
        }
        
        function loadWhisky() {
            var html = '<div style="margin-bottom: 20px;">';
            html += '<h3>Whisky Collection ' + currentYear + '</h3>';
            html += '<p style="color: #718096;">Hver deltaker tar med sin whisky til turen</p>';
            html += '</div>';
            
            html += '<div class="table-wrapper">';
            html += '<table>';
            html += '<thead>';
            html += '<tr>';
            html += '<th>Deltaker</th>';
            html += '<th>Hoved Whisky</th>';
            html += '<th>Reserve Whisky</th>';
            html += '<th>Status</th>';
            html += '</tr>';
            html += '</thead>';
            html += '<tbody>';
            
            whiskyCollection.forEach(function(entry) {
                html += '<tr>';
                html += '<td><strong>' + entry.owner + '</strong></td>';
                html += '<td>' + (entry.primary || '<span style="color: #cbd5e0;">Ikke valgt</span>') + '</td>';
                html += '<td>' + (entry.reserve || '<span style="color: #cbd5e0;">-</span>') + '</td>';
                
                if (entry.primary) {
                    html += '<td><span style="color: #48bb78;">✓ Klar</span></td>';
                } else {
                    html += '<td><span style="color: #f56565;">Venter</span></td>';
                }
                
                html += '</tr>';
            });
            
            html += '</tbody>';
            html += '</table>';
            html += '</div>';
            
            document.getElementById('whiskyContent').innerHTML = html;
        }
        
        function toggleSection(element) {
            element.classList.toggle("active");
            var content = element.nextElementSibling;
            content.classList.toggle("show");
        }
        
        function loadAdmin() {
            var html = '';
            
            if (!isAdmin) {
                html = '<div class="admin-section">';
                html += '<h3>Admin Pålogging</h3>';
                html += '<p>Passord:</p>';
                html += '<input type="password" id="adminPassword" placeholder="Skriv inn passord">';
                html += '<button onclick="loginAdmin()">Logg inn</button>';
                html += '</div>';
            } else {
                html = '<div class="admin-section">';
                html += '<h3>Administrator Panel</h3>';
                html += '<button onclick="logoutAdmin()" style="background: #fc8181;">Logg ut</button>';
                html += '</div>';

                // 1. Handicap Calculation Method Toggle
                html += '<button class="collapsible" onclick="toggleSection(this)">⚙️ Handicap Beregningsmetode</button>';
                html += '<div class="collapsible-content">';
                html += '<div style="background: #fef5e7; padding: 15px; border-radius: 10px;">';
                html += '<h4>Velg beregningsmetode for handicap</h4>';
                html += '<div style="margin: 15px 0;">';
                html += '<label style="display: block; margin-bottom: 10px;">';
                html += '<input type="radio" name="handicapMethod" value="slope" ' + (useSlope ? 'checked' : '') + ' onchange="toggleHandicapMethod(true)"> ';
                html += '<strong>Slope-justert</strong> - Bruker slope rating for å beregne banehandicap';
                html += '</label>';
                html += '<label style="display: block;">';
                html += '<input type="radio" name="handicapMethod" value="direct" ' + (!useSlope ? 'checked' : '') + ' onchange="toggleHandicapMethod(false)"> ';
                html += '<strong>Direkte handicap</strong> - Bruker spillerens handicap direkte uten slope-justering';
                html += '</label>';
                html += '</div>';
                
                html += '<h5>Scramble Formel:</h5>';
                html += '<div style="margin: 10px 0;">';
                html += '<label style="display: block; margin-bottom: 8px;">';
                html += '<input type="radio" name="scrambleFormula" value="standard" ' + (scrambleFormula === 'standard' ? 'checked' : '') + ' onchange="changeScrambleFormula(\'standard\')"> ';
                html += '<strong>Standard</strong> - 35% lavest + 15% høyest';
                html += '</label>';
                html += '<label style="display: block; margin-bottom: 8px;">';
                html += '<input type="radio" name="scrambleFormula" value="usga" ' + (scrambleFormula === 'usga' ? 'checked' : '') + ' onchange="changeScrambleFormula(\'usga\')"> ';
                html += '<strong>USGA</strong> - 50% lavest + 10% høyest';
                html += '</label>';
                html += '<label style="display: block;">';
                html += '<input type="radio" name="scrambleFormula" value="custom" ' + (scrambleFormula === 'custom' ? 'checked' : '') + ' onchange="changeScrambleFormula(\'custom\')"> ';
                html += '<strong>Tilpasset</strong> - 70% lavest + 30% høyest';
                html += '</label>';
                html += '</div>';
                html += '</div>';
                html += '</div>';

                // 2. Handicap Editing
                html += '<button class="collapsible" onclick="toggleSection(this)">✏️ Rediger Handicap</button>';
                html += '<div class="collapsible-content">';
                html += '<div class="handicap-edit-grid">';

                players.forEach(function(player) {
                    html += '<div class="handicap-edit-item">';
                    html += '<label>' + player.name + '</label>';
                    html += '<input type="number" step="0.1" min="0" max="54" id="hcp_' + player.id + '" value="' + player.handicap + '" ';
                    html += 'onchange="updateHandicap(' + player.id + ', this.value)">';
                    html += '</div>';
                });

                html += '</div>';
                html += '<button onclick="saveHandicaps()" style="margin-top: 10px;">Lagre Handicap</button>';
                html += '<div id="handicapMessage"></div>';
                html += '</div>';

                // 3. Flight Time Management
                html += '<button class="collapsible" onclick="toggleSection(this)">🕐 Flight Tider</button>';
                html += '<div class="collapsible-content">';
                
                schedule.forEach(function(round) {
                    html += '<div style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 10px;">';
                    html += '<h5>' + round.date + ' - ' + round.course + ' (' + round.type + ')</h5>';
                    
                    if (round.type === 'Individuell' && round.flights) {
                        html += '<div class="flight-time-grid">';
                        round.flights.forEach(function(flight, idx) {
                            html += '<div class="flight-time-item">';
                            html += '<label>Flight ' + (idx + 1) + ': ' + flight.players.join(', ') + '</label>';
                            html += '<input type="time" id="flight_' + round.id + '_' + idx + '" ';
                            html += 'value="' + (flightTimes[round.id + '_flight_' + idx] || '') + '" ';
                            html += 'onchange="updateFlightTime(\'' + round.id + '_flight_' + idx + '\', this.value)">';
                            html += '</div>';
                        });
                        html += '</div>';
                    }
                    
                    if (round.type === 'Scramble' && round.teams) {
                        html += '<div class="flight-time-grid">';
                        round.teams.forEach(function(team, idx) {
                            html += '<div class="flight-time-item">';
                            html += '<label>Lag ' + (idx + 1) + ': ' + team.join(' & ') + '</label>';
                            html += '<input type="time" id="team_' + round.id + '_' + idx + '" ';
                            html += 'value="' + (flightTimes[round.id + '_team_' + idx] || '') + '" ';
                            html += 'onchange="updateFlightTime(\'' + round.id + '_team_' + idx + '\', this.value)">';
                            html += '</div>';
                        });
                        html += '</div>';
                    }
                    
                    html += '</div>';
                });
                
                html += '<button onclick="saveFlightTimes()">Lagre Tider</button>';
                html += '</div>';

                // 4. Competition Hole Configuration
                html += '<button class="collapsible" onclick="toggleSection(this)">🎯 Konkurransehull</button>';
                html += '<div class="collapsible-content">';
                
                schedule.forEach(function(round) {
                    html += '<div style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 10px;">';
                    html += '<h5>' + round.date + ' - ' + round.course + '</h5>';
                    html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px;">';
                    
                    html += '<div>';
                    html += '<label>Longest Drive Hull (kommaseparert):</label>';
                    html += '<input type="text" id="ld_' + round.id + '" value="' + (round.longestDrive ? round.longestDrive.join(',') : '') + '" ';
                    html += 'placeholder="f.eks. 5,15" onchange="updateCompetitionHoles(' + round.id + ', \'longestDrive\', this.value)">';
                    html += '</div>';
                    
                    html += '<div>';
                    html += '<label>Closest to Pin Hull (kommaseparert):</label>';
                    html += '<input type="text" id="ctp_' + round.id + '" value="' + (round.closestToPin ? round.closestToPin.join(',') : '') + '" ';
                    html += 'placeholder="f.eks. 2,13" onchange="updateCompetitionHoles(' + round.id + ', \'closestToPin\', this.value)">';
                    html += '</div>';
                    
                    html += '</div>';
                    html += '</div>';
                });
                
                html += '<button onclick="saveCompetitionHoles()">Lagre Konkurransehull</button>';
                html += '</div>';

                // 5. Award Winners
                html += '<button class="collapsible" onclick="toggleSection(this)">🏆 Konkurransevinnere</button>';
                html += '<div class="collapsible-content">';

                schedule.forEach(function(round) {
                    html += '<div style="margin-bottom: 20px;">';
                    html += '<h5>' + round.date + ' - ' + round.course + ' (' + round.type + ')</h5>';
                    html += '<div class="award-select">';
                    
                    if (round.longestDrive && round.longestDrive.length > 0) {
                        round.longestDrive.forEach(function(hole) {
                            html += '<div class="award-input">';
                            html += '<label>Longest Drive Hull ' + hole + ':</label>';
                            html += '<select id="award_' + round.id + '_ld_' + hole + '" onchange="updateAward(\'' + round.id + '_ld_' + hole + '\', this.value)">';
                            html += '<option value="">-- Velg vinner --</option>';
                            players.forEach(function(player) {
                                var selected = awards[round.id + '_ld_' + hole] === player.name ? 'selected' : '';
                                html += '<option value="' + player.name + '" ' + selected + '>' + player.name + '</option>';
                            });
                            html += '</select>';
                            html += '</div>';
                        });
                    }
                    
                    if (round.closestToPin && round.closestToPin.length > 0) {
                        round.closestToPin.forEach(function(hole) {
                            html += '<div class="award-input">';
                            html += '<label>Closest to Pin Hull ' + hole + ':</label>';
                            html += '<select id="award_' + round.id + '_ctp_' + hole + '" onchange="updateAward(\'' + round.id + '_ctp_' + hole + '\', this.value)">';
                            html += '<option value="">-- Velg vinner --</option>';
                            players.forEach(function(player) {
                                var selected = awards[round.id + '_ctp_' + hole] === player.name ? 'selected' : '';
                                html += '<option value="' + player.name + '" ' + selected + '>' + player.name + '</option>';
                            });
                            html += '</select>';
                            html += '</div>';
                        });
                    }
                    
                    html += '</div>';
                    html += '</div>';
                });

                html += '<button onclick="saveAwards()">Lagre Vinnere</button>';
                html += '</div>';

                // 6. Course Data Management
                html += '<button class="collapsible" onclick="toggleSection(this)">🏌 Banedata</button>';
                html += '<div class="collapsible-content">';
                
                Object.keys(courses).forEach(function(courseName) {
                    var course = courses[courseName];
                    html += '<div style="margin-bottom: 30px; padding: 15px; background: white; border-radius: 10px;">';
                    html += '<h5>' + courseName + '</h5>';
                    
                    // Course settings
                    html += '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px;">';
                    html += '<div>';
                    html += '<label>Slope Rating:</label>';
                    html += '<input type="number" value="' + course.slopeRating + '" onchange="updateCourseData(\'' + courseName + '\', \'slopeRating\', this.value)">';
                    html += '</div>';
                    html += '<div>';
                    html += '<label>Par:</label>';
                    html += '<input type="number" value="' + course.par + '" onchange="updateCourseData(\'' + courseName + '\', \'par\', this.value)">';
                    html += '</div>';
                    html += '<div>';
                    html += '<label>Course Rating:</label>';
                    html += '<input type="number" step="0.1" value="' + course.courseRating + '" onchange="updateCourseData(\'' + courseName + '\', \'courseRating\', this.value)">';
                    html += '</div>';
                    html += '</div>';
                    
                    // Front 9
                    html += '<h6>Front 9</h6>';
                    html += '<div class="course-edit-grid">';
                    for (var i = 0; i < 9; i++) {
                        html += '<div class="course-edit-hole">';
                        html += '<label>Hull ' + (i + 1) + '</label>';
                        html += '<input type="number" placeholder="Par" value="' + course.pars[i] + '" onchange="updateHolePar(\'' + courseName + '\', ' + i + ', this.value)">';
                        html += '<input type="number" placeholder="SI" min="1" max="18" value="' + course.handicaps[i] + '" onchange="updateHoleHandicap(\'' + courseName + '\', ' + i + ', this.value)">';
                        html += '</div>';
                    }
                    html += '</div>';
                    
                    // Back 9
                    html += '<h6>Back 9</h6>';
                    html += '<div class="course-edit-grid">';
                    for (var i = 9; i < 18; i++) {
                        html += '<div class="course-edit-hole">';
                        html += '<label>Hull ' + (i + 1) + '</label>';
                        html += '<input type="number" placeholder="Par" value="' + course.pars[i] + '" onchange="updateHolePar(\'' + courseName + '\', ' + i + ', this.value)">';
                        html += '<input type="number" placeholder="SI" min="1" max="18" value="' + course.handicaps[i] + '" onchange="updateHoleHandicap(\'' + courseName + '\', ' + i + ', this.value)">';
                        html += '</div>';
                    }
                    html += '</div>';
                    
                    html += '</div>';
                });
                
                html += '<button onclick="saveCourseData()">Lagre Banedata</button>';
                html += '<div id="courseDataMessage"></div>';
                html += '</div>';

                // 7. Historical Data Management
                html += '<button class="collapsible" onclick="toggleSection(this)">📚 Historiske Data</button>';
                html += '<div class="collapsible-content">';
                html += '<div style="background: #f0f9ff; padding: 15px; border-radius: 10px;">';
                html += '<h4>Spillte Baner Management</h4>';
                html += '<p style="color: #718096; margin-bottom: 15px;">Totalt ' + playedCourses.length + ' baner registrert</p>';
                
                html += '<div style="margin-bottom: 15px;">';
                html += '<h5>Legg til ny bane:</h5>';
                html += '<input type="text" id="newCourseName" placeholder="Banenavn" style="width: 60%; margin-right: 10px;">';
                html += '<input type="number" id="newCourseYear" placeholder="År" style="width: 20%; margin-right: 10px;">';
                html += '<button onclick="addHistoricalCourse()">Legg til</button>';
                html += '</div>';
                
                html += '<div style="max-height: 300px; overflow-y: auto;">';
                playedCourses.forEach(function(course, idx) {
                    html += '<div style="display: flex; justify-content: space-between; align-items: center; padding: 5px; border-bottom: 1px solid #e2e8f0;">';
                    html += '<span><strong>' + course.name + '</strong> (' + course.years.join(', ') + ')</span>';
                    html += '<button onclick="removeHistoricalCourse(' + idx + ')" style="background: #ef4444; padding: 5px 10px;">Fjern</button>';
                    html += '</div>';
                });
                html += '</div>';
                html += '</div>';
                html += '</div>';

                // 8. Whisky Management
                html += '<button class="collapsible" onclick="toggleSection(this)">🥃 Whisky Samling</button>';
                html += '<div class="collapsible-content">';

                whiskyCollection.forEach(function(entry) {
                    html += '<div style="margin-bottom: 15px; padding: 10px; background: white; border-radius: 8px;">';
                    html += '<h5>' + entry.owner + '</h5>';
                    html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">';
                    
                    html += '<div>';
                    html += '<label style="display: block; font-size: 12px; margin-bottom: 5px;">Hoved Whisky:</label>';
                    html += '<input type="text" id="whisky_primary_' + entry.id + '" value="' + (entry.primary || '') + '" ';
                    html += 'placeholder="F.eks. Glenmorangie" style="width: 100%; padding: 5px; border: 1px solid #cbd5e0; border-radius: 5px;">';
                    html += '</div>';
                    
                    html += '<div>';
                    html += '<label style="display: block; font-size: 12px; margin-bottom: 5px;">Reserve Whisky:</label>';
                    html += '<input type="text" id="whisky_reserve_' + entry.id + '" value="' + (entry.reserve || '') + '" ';
                    html += 'placeholder="Valgfritt" style="width: 100%; padding: 5px; border: 1px solid #cbd5e0; border-radius: 5px;">';
                    html += '</div>';
                    
                    html += '</div>';
                    html += '</div>';
                });

                html += '<button onclick="saveWhisky()">Lagre Whisky Samling</button>';
                html += '</div>';

                // 10. Tournament Year Management
                html += '<button class="collapsible" onclick="toggleSection(this)">📅 Turnering År Management</button>';
                html += '<div class="collapsible-content">';
                html += '<div style="background: #f0f9ff; padding: 15px; border-radius: 10px;">';
                html += '<h4>Nytt Turnering År</h4>';
                html += '<p style="color: #718096; margin-bottom: 15px;">Opprett nytt år og arkiver nåværende resultater</p>';
                
                html += '<div style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 8px; border: 2px solid #fbbf24;">';
                html += '<h5>⚠️ Viktig informasjon</h5>';
                html += '<p style="font-size: 14px; margin-bottom: 10px;">Når du oppretter et nytt turnering år vil:</p>';
                html += '<ul style="margin-left: 20px; font-size: 13px;">';
                html += '<li>Alle resultater fra ' + currentYear + ' bli arkivert i historien</li>';
                html += '<li>Individuell resultatliste bli lagret</li>';
                html += '<li>Scramble resultater bli lagret</li>';
                html += '<li>Konkurransevinnere (longest drive/closest to pin) bli lagret</li>';
                html += '<li>Nye tomme scorekort bli opprettet for det nye året</li>';
                html += '<li>Spillere og handicap bli beholdt</li>';
                html += '</ul>';
                html += '</div>';
                
                html += '<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px; margin: 15px 0;">';
                html += '<input type="number" id="newTournamentYear" placeholder="Nytt år (f.eks. 2026)" min="2025" max="2035" value="' + (currentYear + 1) + '">';
                html += '<button onclick="createNewTournamentYear()" style="background: #10b981;">Opprett År</button>';
                html += '</div>';
                
                // Show available years
                var availableYears = Object.keys(yearlyData).sort().reverse();
                html += '<div style="margin-top: 20px;">';
                html += '<h5>Tilgjengelige Turnering År:</h5>';
                html += '<div style="max-height: 150px; overflow-y: auto; margin-top: 10px;">';
                availableYears.forEach(function(year) {
                    var isCurrentYear = parseInt(year) === currentYear;
                    html += '<div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #e2e8f0; ' + (isCurrentYear ? 'background: #fef3c7;' : '') + '">';
                    html += '<span><strong>' + year + '</strong>' + (isCurrentYear ? ' (Aktiv)' : '') + '</span>';
                    if (!isCurrentYear && availableYears.length > 1) {
                        html += '<button onclick="switchToYear(' + year + ')" style="background: #3b82f6; padding: 5px 10px;">Bytt til</button>';
                    }
                    html += '</div>';
                });
                html += '</div>';
                html += '</div>';
                
                html += '</div>';
                html += '</div>';

                // 11. Participant Management (moved down to make room)
                html += '<button class="collapsible" onclick="toggleSection(this)">👥 Deltaker Management</button>';
                html += '<div class="collapsible-content">';
                html += '<div style="background: #fef5e7; padding: 15px; border-radius: 10px;">';
                html += '<h4>Legg til ny deltaker:</h4>';
                html += '<div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 10px; margin: 10px 0;">';
                html += '<input type="text" id="newPlayerName" placeholder="Navn">';
                html += '<input type="number" id="newPlayerHandicap" placeholder="Handicap" step="0.1" min="0" max="54">';
                html += '<button onclick="addPlayer()">Legg til</button>';
                html += '</div>';
                
                html += '<h4 style="margin-top: 20px;">Nåværende deltakere:</h4>';
                html += '<div style="max-height: 200px; overflow-y: auto;">';
                players.forEach(function(player, idx) {
                    html += '<div style="display: flex; justify-content: space-between; align-items: center; padding: 5px; border-bottom: 1px solid #e2e8f0;">';
                    html += '<span><strong>' + player.name + '</strong> (HCP: ' + player.handicap + ')</span>';
                    if (players.length > 2) { // Keep at least 2 players
                        html += '<button onclick="removePlayer(' + player.id + ')" style="background: #ef4444; padding: 5px 10px;">Fjern</button>';
                    }
                    html += '</div>';
                });
                html += '</div>';
                html += '</div>';
                html += '</div>';
            }
            
            document.getElementById('adminContent').innerHTML = html;
        }
        
        function loginAdmin() {
            var password = document.getElementById('adminPassword').value;
            if (password === 'golf') {
                isAdmin = true;
                loadAdmin();
            } else {
                alert('Feil passord');
            }
        }
        
        function logoutAdmin() {
            isAdmin = false;
            loadAdmin();
        }
        
        // Admin functions
        function toggleHandicapMethod(useSloping) {
            useSlope = useSloping;
            saveToStorage();
            showMessage('Handicap metode endret!');
        }
        
        function changeScrambleFormula(formula) {
            scrambleFormula = formula;
            saveToStorage();
            showMessage('Scramble formel endret!');
        }

        function updateHandicap(playerId, value) {
            var player = players.find(function(p) { return p.id === playerId; });
            if (player) {
                player.handicap = parseFloat(value);
            }
        }
        
        function saveHandicaps() {
            saveToStorage();
            document.getElementById('handicapMessage').innerHTML = '<div class="success-message">Handicap lagret!</div>';
            setTimeout(function() {
                document.getElementById('handicapMessage').innerHTML = '';
            }, 3000);
        }
        
        function updateFlightTime(key, value) {
            flightTimes[key] = value;
            saveToStorage();
        }
        
        function saveFlightTimes() {
            saveToStorage();
            showMessage('Flight tider lagret!');
        }
        
        function updateCompetitionHoles(roundId, type, value) {
            var round = schedule.find(function(r) { return r.id === roundId; });
            if (round) {
                var holes = value.split(',').map(function(h) { return parseInt(h.trim()); }).filter(function(h) { return !isNaN(h) && h >= 1 && h <= 18; });
                round[type] = holes;
            }
        }
        
        function saveCompetitionHoles() {
            saveToStorage();
            showMessage('Konkurransehull lagret!');
        }
        
        function updateAward(key, value) {
            awards[key] = value;
            saveToStorage();
        }
        
        function saveAwards() {
            saveToStorage();
            showMessage('Vinnere lagret!');
        }
        
        function updateCourseData(courseName, property, value) {
            if (courses[courseName]) {
                courses[courseName][property] = property === 'slopeRating' || property === 'par' ? parseInt(value) : parseFloat(value);
            }
        }
        
        function updateHolePar(courseName, holeIndex, value) {
            if (courses[courseName]) {
                courses[courseName].pars[holeIndex] = parseInt(value);
            }
        }
        
        function updateHoleHandicap(courseName, holeIndex, value) {
            if (courses[courseName]) {
                courses[courseName].handicaps[holeIndex] = parseInt(value);
            }
        }
        
        function saveCourseData() {
            // Validate stroke indexes
            var isValid = true;
            var errorMessage = '';
            
            Object.keys(courses).forEach(function(courseName) {
                var course = courses[courseName];
                var handicaps = course.handicaps.slice().sort(function(a, b) { return a - b; });
                for (var i = 1; i <= 18; i++) {
                    if (handicaps.indexOf(i) === -1) {
                        isValid = false;
                        errorMessage = courseName + ': Stroke Index ' + i + ' mangler';
                        return;
                    }
                }
                
                // Update par total
                course.par = course.pars.reduce(function(sum, par) { return sum + par; }, 0);
            });
            
            if (isValid) {
                saveToStorage();
                document.getElementById('courseDataMessage').innerHTML = '<div class="success-message">Banedata lagret!</div>';
            } else {
                document.getElementById('courseDataMessage').innerHTML = '<div style="background: #fed7d7; color: #c53030; padding: 10px; border-radius: 8px;">Feil: ' + errorMessage + '</div>';
            }
            
            setTimeout(function() {
                document.getElementById('courseDataMessage').innerHTML = '';
            }, 5000);
        }
        
        function addHistoricalCourse() {
            var name = document.getElementById('newCourseName').value.trim();
            var year = parseInt(document.getElementById('newCourseYear').value);
            
            if (name && year && year >= 2000 && year <= 2030) {
                var existingCourse = playedCourses.find(function(c) { return c.name === name; });
                
                if (existingCourse) {
                    if (existingCourse.years.indexOf(year) === -1) {
                        existingCourse.years.push(year);
                        existingCourse.years.sort();
                    }
                } else {
                    var newId = Math.max.apply(null, playedCourses.map(function(c) { return c.id; })) + 1;
                    playedCourses.push({
                        id: newId,
                        name: name,
                        years: [year]
                    });
                }
                
                document.getElementById('newCourseName').value = '';
                document.getElementById('newCourseYear').value = '';
                saveToStorage();
                loadAdmin();
                showMessage('Bane lagt til!');
            } else {
                alert('Vennligst fyll inn gyldig navn og år');
            }
        }
        
        function removeHistoricalCourse(index) {
            if (confirm('Er du sikker på at du vil fjerne denne banen?')) {
                playedCourses.splice(index, 1);
                saveToStorage();
                loadAdmin();
                showMessage('Bane fjernet!');
            }
        }
        
        function addPlayer() {
            var name = document.getElementById('newPlayerName').value.trim();
            var handicap = parseFloat(document.getElementById('newPlayerHandicap').value);
            
            if (name && !isNaN(handicap) && handicap >= 0 && handicap <= 54) {
                var existingPlayer = players.find(function(p) { return p.name === name; });
                
                if (!existingPlayer) {
                    var newId = Math.max.apply(null, players.map(function(p) { return p.id; })) + 1;
                    players.push({
                        id: newId,
                        name: name,
                        handicap: handicap
                    });
                    
                    // Add to whisky collection
                    var newWhiskyId = Math.max.apply(null, whiskyCollection.map(function(w) { return w.id; })) + 1;
                    whiskyCollection.push({
                        id: newWhiskyId,
                        owner: name,
                        primary: '',
                        reserve: ''
                    });
                    
                    document.getElementById('newPlayerName').value = '';
                    document.getElementById('newPlayerHandicap').value = '';
                    saveToStorage();
                    loadAdmin();
                    showMessage('Spiller lagt til!');
                } else {
                    alert('Spiller med dette navnet eksisterer allerede');
                }
            } else {
                alert('Vennligst fyll inn gyldig navn og handicap (0-54)');
            }
        }
        
        function removePlayer(playerId) {
            if (players.length <= 2) {
                alert('Kan ikke fjerne spillere - minimum 2 spillere kreves');
                return;
            }
            
            var player = players.find(function(p) { return p.id === playerId; });
            if (player && confirm('Er du sikker på at du vil fjerne ' + player.name + '?')) {
                // Remove from players array
                players = players.filter(function(p) { return p.id !== playerId; });
                
                // Remove from whisky collection
                whiskyCollection = whiskyCollection.filter(function(w) { return w.owner !== player.name; });
                
                // Clean up scores and awards
                Object.keys(scores).forEach(function(key) {
                    if (key.includes('_' + playerId)) {
                        delete scores[key];
                    }
                });
                
                Object.keys(awards).forEach(function(key) {
                    if (awards[key] === player.name) {
                        delete awards[key];
                    }
                });
                
                saveToStorage();
                loadAdmin();
                showMessage('Spiller fjernet!');
            }
        }
        
        function saveWhisky() {
            whiskyCollection.forEach(function(entry) {
                var primaryInput = document.getElementById('whisky_primary_' + entry.id);
                var reserveInput = document.getElementById('whisky_reserve_' + entry.id);
                
                if (primaryInput) {
                    entry.primary = primaryInput.value;
                }
                if (reserveInput) {
                    entry.reserve = reserveInput.value;
                }
            });
            
            saveToStorage();
            showMessage('Whisky samling lagret!');
        }
        
        // Tournament year management functions
        function createNewTournamentYear() {
            var newYear = parseInt(document.getElementById('newTournamentYear').value);
            
            if (!newYear || newYear <= currentYear || newYear > 2035) {
                alert('Vennligst skriv inn et gyldig år større enn ' + currentYear);
                return;
            }
            
            var confirmMessage = 'Er du sikker på at du vil opprette turnering år ' + newYear + '?\n\n';
            confirmMessage += 'Dette vil arkivere alle resultater fra ' + currentYear + ' og opprette nye tomme scorekort for ' + newYear + '.';
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            // Archive current year results
            archiveCurrentYearResults();
            
            // Create new year structure
            yearlyData[newYear] = {
                individual: {},
                scramble: {},
                awards: {},
                courses: JSON.parse(JSON.stringify(courses)), // Deep copy current courses
                schedule: JSON.parse(JSON.stringify(schedule)), // Deep copy schedule structure
                flightTimes: {},
                archived: {
                    overallWinner: null,
                    scrambleWinners: [],
                    competitionWinners: {},
                    finalStandings: [],
                    tournamentStats: {}
                }
            };
            
            // Switch to new year
            currentYear = newYear;
            scores = {};
            scrambleScores = {};
            awards = {};
            flightTimes = {};
            
            // Update schedule IDs for new year to avoid conflicts
            schedule.forEach(function(round, idx) {
                round.id = (newYear * 100) + idx + 1;
            });
            
            saveToStorage();
            
            showMessage('Turnering år ' + newYear + ' opprettet! Alle ' + (newYear - 1) + ' resultater er arkivert.');
            loadAdmin(); // Reload admin panel
        }
        
        function archiveCurrentYearResults() {
            if (!yearlyData[currentYear]) return;
            
            // Calculate final overall standings
            var overallScores = {};
            players.forEach(function(player) {
                overallScores[player.name] = { points: 0, rounds: 0 };
            });
            
            // Calculate individual tournament results
            schedule.forEach(function(round) {
                if (round.type === 'Individuell') {
                    players.forEach(function(player) {
                        var scoreKey = round.id + '_' + player.id;
                        var roundScores = scores[scoreKey];
                        
                        if (roundScores && Object.keys(roundScores).length > 0) {
                            var course = courses[round.course];
                            var courseHandicap = calculateCourseHandicap(player.handicap, course.slopeRating);
                            
                            var totalPoints = 0;
                            Object.keys(roundScores).forEach(function(hole) {
                                var holeNum = parseInt(hole);
                                var strokes = roundScores[hole];
                                var par = course.pars[holeNum - 1];
                                var hcpIndex = course.handicaps[holeNum - 1];
                                
                                var strokesOnHole = 0;
                                if (courseHandicap >= 18) {
                                    strokesOnHole = 1;
                                    if (hcpIndex <= (courseHandicap - 18)) strokesOnHole = 2;
                                    if (courseHandicap >= 36 && hcpIndex <= (courseHandicap - 36)) strokesOnHole = 3;
                                } else {
                                    if (hcpIndex <= courseHandicap) strokesOnHole = 1;
                                }
                                
                                totalPoints += calculateStablefordPoints(strokes, par, strokesOnHole);
                            });
                            
                            overallScores[player.name].points += totalPoints;
                            overallScores[player.name].rounds++;
                        }
                    });
                }
            });
            
            // Sort final standings
            var finalStandings = [];
            Object.keys(overallScores).forEach(function(name) {
                if (overallScores[name].rounds > 0) {
                    finalStandings.push({
                        name: name,
                        points: overallScores[name].points,
                        rounds: overallScores[name].rounds
                    });
                }
            });
            finalStandings.sort(function(a, b) { return b.points - a.points; });
            
            // Calculate scramble winners
            var scrambleWinners = [];
            schedule.forEach(function(round) {
                if (round.type === 'Scramble') {
                    var roundWinners = [];
                    var scrambleResults = [];
                    
                    round.teams.forEach(function(team, idx) {
                        var scoreKey = round.id + '_team_' + idx;
                        var teamScores = scrambleScores[scoreKey];
                        
                        if (teamScores) {
                            var totalStrokes = 0;
                            var holesPlayed = 0;
                            Object.keys(teamScores).forEach(function(hole) {
                                totalStrokes += teamScores[hole];
                                holesPlayed++;
                            });
                            
                            if (holesPlayed > 0) {
                                var teamHandicap = calculateScrambleHandicap(team, round.course);
                                var allocatedStrokes = Math.round(teamHandicap);
                                var netScore = totalStrokes - allocatedStrokes;
                                
                                scrambleResults.push({
                                    team: team.join(' & '),
                                    gross: totalStrokes,
                                    handicap: allocatedStrokes,
                                    net: netScore,
                                    course: round.course,
                                    date: round.date
                                });
                            }
                        }
                    });
                    
                    scrambleResults.sort(function(a, b) { return a.net - b.net; });
                    if (scrambleResults.length > 0) {
                        scrambleWinners.push({
                            course: round.course,
                            date: round.date,
                            winner: scrambleResults[0],
                            results: scrambleResults
                        });
                    }
                }
            });
            
            // Archive the results
            yearlyData[currentYear].archived = {
                overallWinner: finalStandings.length > 0 ? finalStandings[0] : null,
                finalStandings: finalStandings,
                scrambleWinners: scrambleWinners,
                competitionWinners: awards,
                tournamentStats: {
                    totalPlayers: players.length,
                    totalRounds: schedule.length,
                    coursesPlayed: Object.keys(courses)
                },
                archivedDate: new Date().toISOString()
            };
        }
        
        function switchToYear(year) {
            if (confirm('Bytte til turnering år ' + year + '? Alle endringer i nåværende år vil bli lagret.')) {
                saveToStorage(); // Save current state
                
                currentYear = parseInt(year);
                
                // Load data for selected year
                if (yearlyData[currentYear]) {
                    scores = yearlyData[currentYear].individual || {};
                    scrambleScores = yearlyData[currentYear].scramble || {};
                    awards = yearlyData[currentYear].awards || {};
                    flightTimes = yearlyData[currentYear].flightTimes || {};
                    
                    if (yearlyData[currentYear].courses) {
                        courses = yearlyData[currentYear].courses;
                    }
                    if (yearlyData[currentYear].schedule) {
                        schedule = yearlyData[currentYear].schedule;
                    }
                }
                
                saveToStorage();
                showMessage('Byttet til turnering år ' + year);
                
                // Update page title
                document.getElementById('appTitle').textContent = 'Scotland Golf ' + currentYear;
                
                loadAdmin(); // Reload admin panel
            }
        }
        
        // Initialize on load
window.onload = function() {
    console.log('App initializing - reading from server only...');
    
    // Only sync with server, no localStorage fallback
    syncWithServer().then(function() {
        updateLanguage();
        updatePageTitle();
        console.log('Server-only initialization completed');
    }).catch(function(error) {
        console.error('Server initialization failed:', error);
        // If server fails, use default hardcoded data only
        updateLanguage();
        updatePageTitle();
    });
};
        // Add this function to your JavaScript (around line 2000, near other utility functions)

function showMessage(message, type = 'success') {
    // Create message element if it doesn't exist
    var messageElement = document.getElementById('globalMessage');
    if (!messageElement) {
        messageElement = document.createElement('div');
        messageElement.id = 'globalMessage';
        messageElement.style.cssText = `
            position: fixed;
            top: 70px;
            right: 20px;
            z-index: 1001;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transform: translateX(400px);
            transition: transform 0.3s ease;
            max-width: 300px;
            word-wrap: break-word;
        `;
        document.body.appendChild(messageElement);
    }
    
    // Set message content and style based on type
    messageElement.textContent = message;
    
    switch(type) {
        case 'success':
            messageElement.style.background = '#48bb78';
            break;
        case 'error':
            messageElement.style.background = '#e53e3e';
            break;
        case 'warning':
            messageElement.style.background = '#ed8936';
            break;
        default:
            messageElement.style.background = '#4299e1';
    }
    
    // Show message
    setTimeout(() => {
        messageElement.style.transform = 'translateX(0)';
    }, 100);
    
    // Hide message after delay
    setTimeout(() => {
        messageElement.style.transform = 'translateX(400px)';
    }, 3000);
}
        // Enhanced sync with server
async function syncWithServer() {
    try {
        console.log('Loading from server...');
        var response = await fetch('/api/scores');
        if (response.ok) {
            var serverData = await response.json();
            console.log('Server data loaded successfully');
            
            // Always use server data if available
            if (serverData.yearlyData) {
                yearlyData = serverData.yearlyData;
                scores = yearlyData[currentYear]?.individual || {};
                scrambleScores = yearlyData[currentYear]?.scramble || {};
                awards = yearlyData[currentYear]?.awards || {};
                flightTimes = yearlyData[currentYear]?.flightTimes || {};
            }
            
            if (serverData.players) {
                players = serverData.players;
            }
            if (serverData.playedCourses) {
                playedCourses = serverData.playedCourses;
            }
            if (serverData.whiskyCollection) {
                whiskyCollection = serverData.whiskyCollection;
            }
            if (serverData.useSlope !== undefined) {
                useSlope = serverData.useSlope;
            }
            if (serverData.scrambleFormula) {
                scrambleFormula = serverData.scrambleFormula;
            }
            if (serverData.courses) {
                courses = serverData.courses;
            }
            if (serverData.schedule) {
                schedule = serverData.schedule;
            }
            
            console.log('All data loaded from server');
            
        } else {
            throw new Error('Server response not ok: ' + response.status);
        }
    } catch (e) {
        console.error('Server load failed:', e.message);
        throw e;
    }
}
// Enhanced save to server
async function saveToServer() {
    try {
        console.log('Saving to server...');
        
        // Ensure current year data is up to date
        if (!yearlyData[currentYear]) {
            yearlyData[currentYear] = {
                individual: {},
                scramble: {},
                awards: {},
                courses: {},
                schedule: [],
                flightTimes: {}
            };
        }
        
        yearlyData[currentYear].individual = scores;
        yearlyData[currentYear].scramble = scrambleScores;
        yearlyData[currentYear].awards = awards;
        yearlyData[currentYear].courses = courses;
        yearlyData[currentYear].schedule = schedule;
        yearlyData[currentYear].flightTimes = flightTimes;
        
        var dataToSend = {
            yearlyData: yearlyData,
            players: players,
            playedCourses: playedCourses,
            whiskyCollection: whiskyCollection,
            courses: courses,
            schedule: schedule,
            useSlope: useSlope,
            scrambleFormula: scrambleFormula,
            currentYear: currentYear,
            timestamp: new Date().toISOString(),
            
            // Current year shortcuts for legacy compatibility
            scores: scores,
            scrambleScores: scrambleScores,
            awards: awards,
            flightTimes: flightTimes
        };
        
        var response = await fetch('/api/scores', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(dataToSend)
        });
        
        if (response.ok) {
            var result = await response.json();
            console.log('Server save successful:', result.timestamp);
            return true;
        } else {
            console.error('Server save failed:', response.status);
            return false;
        }
    } catch (e) {
        console.error('Server save error:', e.message);
        return false;
    }
}

// Enhanced localStorage functions
function loadFromStorage() {
    console.log('Loading from localStorage...');
    
    var savedYearlyData = localStorage.getItem('golfYearlyData');
    if (savedYearlyData) {
        try {
            yearlyData = JSON.parse(savedYearlyData);
            if (!yearlyData[currentYear]) {
                yearlyData[currentYear] = {
                    individual: {},
                    scramble: {},
                    awards: {},
                    courses: {},
                    schedule: [],
                    flightTimes: {}
                };
            }
            console.log('Loaded yearly data from localStorage');
        } catch (e) {
            console.log('Error loading yearly data from localStorage');
        }
    }
    
    scores = yearlyData[currentYear].individual || {};
    scrambleScores = yearlyData[currentYear].scramble || {};
    awards = yearlyData[currentYear].awards || {};
    flightTimes = yearlyData[currentYear].flightTimes || {};
    
    var savedPlayers = localStorage.getItem('golfPlayers');
    if (savedPlayers) {
        try {
            var parsed = JSON.parse(savedPlayers);
            if (Array.isArray(parsed) && parsed.length > 0) {
                players = parsed;
                console.log('Loaded players from localStorage');
            }
        } catch (e) {
            console.log('Error loading players from localStorage');
        }
    }
    
    // Load admin settings
    useSlope = localStorage.getItem('useSlope') === 'false' ? false : true;
    scrambleFormula = localStorage.getItem('scrambleFormula') || 'standard';
    
    console.log('localStorage load completed');
}

function saveToStorage() {
    try {
        // Ensure current year data is up to date
        yearlyData[currentYear].individual = scores;
        yearlyData[currentYear].scramble = scrambleScores;
        yearlyData[currentYear].awards = awards;
        yearlyData[currentYear].courses = courses;
        yearlyData[currentYear].schedule = schedule;
        yearlyData[currentYear].flightTimes = flightTimes;
        
        localStorage.setItem('golfYearlyData', JSON.stringify(yearlyData));
        localStorage.setItem('golfPlayers', JSON.stringify(players));
        localStorage.setItem('useSlope', useSlope.toString());
        localStorage.setItem('scrambleFormula', scrambleFormula);
        
        // Try to sync with server in background
        saveToServer().catch(function(error) {
            console.log('Background server sync failed:', error);
        });
        
        console.log('Data saved to localStorage');
    } catch (e) {
        console.error('Error saving to localStorage:', e);
    }
}

// Update the window.onload function
window.onload = function() {
    console.log('App initializing...');
    
    // First try to sync with server, fallback to localStorage
    syncWithServer().then(function() {
        updateLanguage();
        updatePageTitle();
        console.log('App initialization completed');
    }).catch(function(error) {
        console.error('Initialization error:', error);
        updateLanguage();
        updatePageTitle();
    });
};

// Auto-save functions should also trigger server sync
function autoSaveScore(playerId, roundId, hole) {
    var scoreKey = roundId + '_' + playerId;
    var value = document.getElementById('hole' + hole).value;
    
    if (!scores[scoreKey]) scores[scoreKey] = {};
    
    if (value === '') {
        delete scores[scoreKey][hole];
        var holeDiv = document.getElementById('hole' + hole).closest('.hole-input');
        holeDiv.classList.remove('pickup-score');
    } else {
        scores[scoreKey][hole] = parseInt(value);
    }
    
    saveToStorage(); // This will trigger server sync
    
    var input = document.getElementById('hole' + hole);
    input.style.backgroundColor = '#c6f6d5';
    setTimeout(function() {
        input.style.backgroundColor = '';
    }, 500);
}

function autoSaveTeamScore(roundId, teamIdx, hole) {
    var scoreKey = roundId + '_team_' + teamIdx;
    var value = document.getElementById('hole' + hole).value;
    
    if (!scrambleScores[scoreKey]) scrambleScores[scoreKey] = {};
    
    if (value === '') {
        delete scrambleScores[scoreKey][hole];
    } else {
        scrambleScores[scoreKey][hole] = parseInt(value);
    }
    
    saveToStorage(); // This will trigger server sync
    
    var input = document.getElementById('hole' + hole);
    input.style.backgroundColor = '#c6f6d5';
    setTimeout(function() {
        input.style.backgroundColor = '';
    }, 500);
}

        // Add this function anywhere in your <script> section
function restoreDefaultData() {
    // Restore default playedCourses
    playedCourses = [
        { id: 1, name: 'Murrayshall GC - Old Course', years: [2010, 2014, 2018] },
        { id: 2, name: 'Murrayshall GC - New Course', years: [2010, 2014, 2018] },
        { id: 3, name: 'Newmacher GC - Hawkshill', years: [2010, 2011, 2012, 2018, 2022] },
        { id: 4, name: 'Newmacher GC - Swailend', years: [2013] },
        { id: 5, name: 'Cruden Bay', years: [2011, 2013, 2015] },
        { id: 6, name: 'Criff GC', years: [2010] },
        { id: 7, name: 'Gleneagle GC - Kings Course', years: [2010] },
        { id: 8, name: 'Royal Aberdeen GC', years: [2012] },
        { id: 9, name: 'Craibstone GC', years: [2011, 2016] },
        { id: 10, name: 'Hazelhead GC - Bane 1', years: [2012] },
        { id: 11, name: 'Hazelhead GC - Bane 2', years: [2012] },
        { id: 12, name: 'Newburgh on Ythan GC', years: [2013] },
        { id: 13, name: 'Meldrum', years: [2015] },
        { id: 14, name: 'Cullen GC', years: [2016] },
        { id: 15, name: 'Duff House Royal GC', years: [2016] },
        { id: 16, name: 'Lundin GC', years: [2017] },
        { id: 17, name: 'Craighead Links', years: [2017] },
        { id: 18, name: 'Balcomie Links', years: [2017] },
        { id: 19, name: 'St. Andrew Eden Course', years: [2017] },
        { id: 20, name: 'St. Andrew GC', years: [2019] },
        { id: 21, name: 'Crail Golf Society', years: [2021] },
        { id: 22, name: 'Stonehaven GC', years: [2021] },
        { id: 23, name: 'Leven GC', years: [2021] },
        { id: 24, name: 'Nairn Golf Club', years: [2022] },
        { id: 25, name: 'Nairn Dunbar Golf Club', years: [2022] },
        { id: 26, name: 'Cullen Links', years: [2023, 2024, 2025] },
        { id: 27, name: 'Spey Bay', years: [2023, 2024, 2025] },
        { id: 28, name: 'Strathlene', years: [2023, 2024, 2025] },
        { id: 29, name: 'Garmouth & Kingston', years: [2023, 2024, 2025] }
    ];
    
    // Restore default whiskyCollection  
    whiskyCollection = [
        { id: 1, owner: 'Ruben', primary: '', reserve: '' },
        { id: 2, owner: 'Dag', primary: 'Glenmorangie', reserve: '' },
        { id: 3, owner: 'Björn', primary: 'Highland Park', reserve: '' },
        { id: 4, owner: 'Sigbjørn', primary: 'MacAllan', reserve: '' },
        { id: 5, owner: 'Truls', primary: 'Dalmore', reserve: 'Old Pultney' },
        { id: 6, owner: 'Roar', primary: 'Glenfiddich', reserve: '' },
        { id: 7, owner: 'Tor Espen', primary: 'Ben Nevis', reserve: '' },
        { id: 8, owner: 'Klaus', primary: 'Balvenie', reserve: '' }
    ];
    
    console.log('Default data restored');
    
    // Save to server immediately
    saveToServer().then(function() {
        alert('Default data restored and saved to server! Refreshing page...');
        location.reload();
    }).catch(function(error) {
        console.error('Error saving:', error);
        alert('Error saving to server, but local data restored');
    });
}
    </script>
</body>
</html>
